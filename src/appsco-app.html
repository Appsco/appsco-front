<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/appsco-header/appsco-header.html">
<link rel="import" href="../bower_components/appsco-header/appsco-account-chat.html">
<link rel="import" href="../bower_components/appsco-components/appsco-api.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-add.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-share.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-remove.html">

<link rel="import" href="application/appsco-home-page-actions.html">
<link rel="import" href="application/appsco-application-page-actions.html">
<link rel="import" href="account/appsco-account-page-actions.html">

<dom-module id="appsco-app">
    <template>
        <style>
            :host {
                --app-primary-color: #1183A4;
                --app-secondary-color: #273441;
                --app-danger-color: #ff0000;
                --body-background-color: #f5f8fa;
                --app-primary-color-dark: #414042;

                --primary-text-color: #414042;
                --secondary-text-color: #969696;

                --primary-button-background-color: var(--app-primary-color);

                --border-radius-base: 3px;

                display: block;

                --paper-progress-active-color: #5AC099;

                --paper-input-container-underline-focus: {
                     height: 1px;
                 };
                --paper-input-container-label-focus: {
                     color: var(--secondary-text-color);
                 };

                 --paper-icon-button: {
                    padding: 0;
                    width: 24px;
                    height: 24px;
                    margin-right: 6px;
                    color: var(--primary-text-color);
                 };

                --paper-progress-height: 2px;

                --paper-dialog-button: {
                     padding: 4px 8px;
                     color: var(--primary-text-color);
                 };
                --paper-dialog-confirm-button: {
                     font-weight: 500;
                 };

                --paper-button-flat-keyboard-focus: {
                     font-weight: normal;
                 };

                --appsco-page-global-action-color: var(--app-primary-color);

                --appsco-list-item: {
                     color: var(--primary-text-color);
                 };

                --appsco-account-info: {
                     color: var(--primary-text-color);
                 };

                --resource-color: var(--primary-text-color);
            }

            /* Top header style START */
            appsco-header {
                height: 64px;
                padding: 16px 10px;
                box-sizing: border-box;
                /*color: var(--app-secondary-color);*/
                color: #ffffff;
                background-color: var(--app-primary-color);

                --appsco-account-action-color: #ffffff;
                /*--appsco-account-action-color: var(--app-primary-color);*/

                --paper-listbox: {
                     color: var(--app-secondary-color);
                 };

                --notifications-paper-card-header-text: {
                     color: var(--primary-text-color);
                 };
            }
            /* Top header style END */

            /* Bottom header style START */
            app-header {
                /*color: #ffffff;*/
                /*background-color: var(--app-primary-color);*/
                background-color: #ffffff;
                box-shadow: 0 3px 3px -2px rgba(0, 0, 0, 0.4);
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }
            app-header .actions {
                height: 100%;
            }
            .page-title {
                margin-right: 10px;
                font-size: 18px;
                color: var(--primary-text-color);
                text-transform: capitalize;
            }
            /* Bottom header style END */

            /* Menu list style START */
            .drawer-list {
            }
            .drawer-list a {
                display: block;
                padding: 0 16px;
                text-decoration: none;
                color: var(--app-secondary-color);
                line-height: 40px;
                border-bottom: 1px solid var(--divider-color);
                outline: none;
            }
            .drawer-list a.iron-selected {
                background-color: var(--google-grey-300);
            }
            /* Menu list style END */

            :host app-drawer-layout[fullbleed] {
                top: 64px;
                overflow: hidden;
            }
            app-drawer {
                top: 64px;
                border-top: 1px solid #ffffff;

                --app-drawer-content-container: {
                     padding-top: 0;
                     background: var(--body-background-color);
                 };
            }
            app-toolbar {
                padding: 0 10px;
            }
            :host .flex-horizontal {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            :host .flex {
                @apply(--layout-flex);
            }
            .pages {
                height: 100%;
            }
            appsco-application-add, appsco-application-share {
                --paper-input-container-underline: {
                     background-color: var(--divider-color);
                 };
                --paper-input-container-underline-focus: {
                     height: 1px;
                     background-color: var(--app-primary-color);
                 };
            }
        </style>

        <appsco-api id="api" domain="https://my-dev.appsco.com" index="" name="{{ api }}"></appsco-api>
        <app-location route="{{route}}"></app-location>

        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subroute}}"></app-route>

        <paper-toast id="toast" text="[[ _toastMessage ]]"></paper-toast>

        <appsco-header
                account="{{ account }}"
                brand-logo="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB3aWR0aD0iMjhweCIgaGVpZ2h0PSIyOHB4IiB2aWV3Qm94PSIwIDAgMjggMjgiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+ICAgICAgICA8dGl0bGU+QXBwc0NvLWxvZ288L3RpdGxlPiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4gICAgPGRlZnM+PC9kZWZzPiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4gICAgICAgIDxnIGlkPSJBcHBzQ28tbG9nbyI+ICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIj4gICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0yIiBmaWxsPSIjMjA5QkMzIiB4PSIwIiB5PSIxNSIgd2lkdGg9IjEzIiBoZWlnaHQ9IjEzIj48L3JlY3Q+ICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMi1Db3B5IiBmaWxsPSIjODhCOTU1IiB4PSIxNSIgeT0iMCIgd2lkdGg9IjEzIiBoZWlnaHQ9IjEzIj48L3JlY3Q+ICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMi1Db3B5LTIiIGZpbGw9IiNFNkQwMjUiIHg9IjE1IiB5PSIxNSIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIj48L3JlY3Q+ICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMi1Db3B5LTMiIGZpbGw9IiNEODNEODIiIHg9IjMiIHk9IjMiIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PC9yZWN0PiAgICAgICAgICAgIDwvZz4gICAgICAgIDwvZz4gICAgPC9nPjwvc3ZnPg=="
                brand-logo-width="32"
                brand-logo-height="32"
                brand-title="AppsCo"
                authorization-token="[[ authorizationToken ]]"
                notifications-api="[[ api.notifications ]]"
                logout-api="[[ api.logout ]]"
                notifications-size="5"
                account-chat
                account-info="Info related to account"
                on-account-chat="_onAccountChat"
                on-account-settings="_onAccountSettingsAction"></appsco-header>

        <app-drawer-layout fullbleed force-narrow>

             <!--Drawer content -->
            <app-drawer id="appDrawer">
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
                    <a name="home" href="/home">Home</a>
                    <a name="account" href="/account">Account</a>
                    <!--<a name="vault" href="/vault">Vault</a>-->
                </iron-selector>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header>
                    <app-toolbar class="flex-horizontal">
                        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                        <div class="page-title" condense-title>[[ page ]]</div>

                        <neon-animated-pages
                                id="animatedActions"
                                class="actions flex flex-end"
                                selected="[[page]]"
                                attr-for-selected="name">

                            <appsco-home-page-actions
                                    name="home"
                                    authorization-token="[[ authorizationToken ]]"
                                    filter-api="[[ api.dashboards ]]?extended=1"
                                    on-add-application="_onAddApplication"
                                    on-search="_searchApplications"
                                    on-group-selected="_onGroupSelected"
                                    on-page-global-info="_onInfoAction"></appsco-home-page-actions>

                            <appsco-application-page-actions
                                    name="application"
                                    on-back="_backToHome"
                                    on-resource-section="_onResourceActionApplicationPage"></appsco-application-page-actions>

                            <appsco-account-page-actions
                                    name="account"
                                    on-back="_backToHome"
                                    on-resource-section="_onResourceActionAccountPage"
                                    on-advanced-settings="_onAccountAdvancedSettings"></appsco-account-page-actions>

                        </neon-animated-pages>

                    </app-toolbar>
                </app-header>

                <neon-animated-pages
                        class="pages"
                        selected="[[page]]"
                        attr-for-selected="name"
                        fallback-selection="404"
                        role="main"
                        on-neon-animation-finish="_onPageAnimationFinish">
                    <appsco-home-page
                            id="appscoHomePage"
                            name="home"
                            application="{{ application }}"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            applications-api="[[ applicationsApi ]]"
                            on-view-application="_onViewApplication"
                            on-share-application="_onShareApplication">
                    </appsco-home-page>

                    <appsco-application-page
                            id="appscoApplicationPage"
                            name="application"
                            application="{{ application }}"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            accounts-api="[[ api.accounts ]]"
                            account="{{ account }}"
                            on-share-application="_onShareApplication"
                            on-remove-application="_onRemoveApplication"
                            on-application-settings-saved="_onApplicationSettingsSaved"
                            on-application-settings-no-changes="_onApplicationSettingsNoChanges">
                    </appsco-application-page>

                    <appsco-account-page
                            id="appscoAccountPage"
                            name="account"
                            account="{{ account }}"
                            authorization-token="[[ authorizationToken ]]"
                            notifications-api="[[ api.notifications ]]"
                            authorized-apps-api="[[ api.authorizedApps ]]"
                            log-api="https://my-dev.appsco.com/api/v2/me/log"
                            two-fa-api="[[ api.twoFA ]]"
                            settings-api="[[ api.me ]]"
                            transfer-token-api="[[ api.transferToken ]]"
                            change-password-api="[[ api.changePassword ]]"
                            on-settings-saved="_onAccountSettingsSaved"
                            on-password-changed="_onAccountPasswordChanged"></appsco-account-page>
                    <appsco-404-page name="404"></appsco-404-page>
                </neon-animated-pages>
            </app-header-layout>
        </app-drawer-layout>

        <appsco-account-chat
                id="appscoAccountChat"
                account="{{ account }}"
                chat="{{ chat }}"
                dont-close-outside>
        </appsco-account-chat>

        <appsco-application-add
                id="appscoApplicationAdd"
                authorization-token="[[ authorizationToken ]]"
                applications-template-api="[[ api.applicationTemplates ]]"
                dashboard-api="[[ addAppApi ]]"
                on-application-added="_onApplicationAdded">
        </appsco-application-add>

        <appsco-application-share
                id="appscoApplicationShare"
                application="[[ application ]]"
                authorization-token="[[ authorizationToken ]]"
                accounts-api="[[ api.accounts ]]"
                on-application-shared="_onApplicationShared"
                ></appsco-application-share>

        <appsco-application-remove
                id="appscoApplicationRemove"
                application="[[ application ]]"
                authorization-token="[[ authorizationToken ]]"
                on-application-removed="_onApplicationRemoved"></appsco-application-remove>

        <template is="dom-if" if="[[ api.me ]]">
            <iron-ajax
                    auto
                    url="[[ api.me ]]"
                    on-response="_onGetAccountResponse"
                    headers="{{ _computedHeaders }}">
            </iron-ajax>
        </template>

        <template is="dom-if" if="[[ api.dashboards ]]">
            <iron-ajax
                    auto
                    url="[[ api.dashboards ]]?extended=1"
                    on-response="_onDashboardsResponse"
                    headers="{{ _computedHeaders }}">
            </iron-ajax>
        </template>
    </template>

    <script>
        Polymer({
            is: 'appsco-app',

            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                },

                api: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true
                },

                account: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    notify: true
                },

                /**
                 * Computed headers.
                 * It contains authorization token.
                 */
                _computedHeaders: {
                    type: Object,
                    computed: "_computeHeaders(authorizationToken)"
                },

                chat: {
                    type: Object,
                    value: function() {
                        return {
                            auth: "auth code",
                            room: "room number",
                            service: "https://www.xxx.com",
                            active: "false"
                        }
                    }
                },

                /**
                 * Selected application.
                 */
                application: {
                    type: Object,
                    notify: true
                },

                /**
                 * Authorization token for logged account.
                 */
                authorizationToken: {
                    type: String,
                    value: 'rtlXv2jBLh_nDsmYrHhAmT2GyfUt7PBslcBfe8Cwx0QDsHQlkV211SlnmKVxqtzvuJxSfDDvjVUQHkRKOIWRJ8'
                },

                addAppApi: {
                    type: String,
                    value: ''
                },

                applicationsApi: {
                    type: String,
                    value: ''
                },

                _globalActions: {
                    type: Boolean,
                    value: true
                },

                _toastMessage: {
                    type: String,
                    value: ''
                }
            },

            observers: [
                '_routePageChanged(routeData.page)'
            ],

            listeners: {
                'api-changed': "_apiChanged"
            },

            _apiChanged: function() {
                this.applicationsApi = this.api.applications +"?extended=1";
            },

            _onDashboardsResponse: function(event) {

                if (event.detail.response) {
                    this.addAppApi = event.detail.response.dashboards[0].self;
                }

            },

            _routePageChanged: function(page) {
                this.page = page || 'home';
            },

            _pageChanged: function(page) {
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('appsco-' + page + '-page.html');
                this.importHref(resolvedPageUrl, null, this._showPage404, true);

                this.$.appDrawer.close();
            },

            _showPage404: function() {
                this.page = '404';
            },

            _backToHome: function() {
                this.set('routeData.page', 'home');
            },

            /**
             * Computes authorization headers.
             *
             * @param {Object} authorizationToken
             * @returns {{ Authorization: string }}
             * @private
             */
            _computeHeaders: function (authorizationToken) {
                return {
                    'Authorization': 'token ' + authorizationToken
                }
            },

            _onResourceActionApplicationPage: function() {
                this.$.appscoApplicationPage.toggleResource();
            },

            _onResourceActionAccountPage: function() {
                this.$.appscoAccountPage.toggleResource();
            },

            _onInfoAction: function() {
                this.$.appscoHomePage.toggleInfo();
            },

            _onViewApplication: function() {
                var applicationLog = this.application.meta.log;

                this.set('routeData.page', 'application');
                this.set('application.meta.log', applicationLog);
            },

            _onShareApplication: function() {
                this.$.appscoApplicationShare.toggle();
            },

            _onApplicationShared: function(event) {
                var application = event.detail.application,
                    applicationLogApi = application.meta.log,
                    message = 'You successfully shared ' + this.application.title + '.';

                // In order to notify.
                this.set('application', {});
                this.set('application', application);

                this._notifyAboutApplicationLogChange(applicationLogApi);
                this._notify(message);
            },

            _onAddApplication: function() {
                this.$.appscoApplicationAdd.toggle();
            },

            _onApplicationAdded: function(event) {
                var application = event.detail.application,
                    message = application.title + ' was successfully saved.';

                this.$.appscoHomePage.addApplication(application);
                this._notify(message);
            },

            _onRemoveApplication: function() {
                this.$.appscoApplicationRemove.open();
            },

            _onApplicationRemoved: function(event) {
                var application = event.detail.application,
                    message = application.title + ' was successfully removed.';

                this.$.appscoHomePage.removeApplication(application);
                this.set('routeData.page', 'home');

                this._notify(message);
            },

            _onApplicationSettingsSaved: function(event) {
                var application = event.detail.application,
                    applicationLogApi = application.meta.log,
                    message = application.title + ' was successfully changed.';

                this.$.appscoHomePage.reloadApplications();
                this._notifyAboutApplicationLogChange(applicationLogApi);
                this._notify(message);
            },

            _onApplicationSettingsNoChanges: function(event) {
                this._notify('No changes have been made to ' + event.detail.application.title + '.');
            },

            _onAccountChat: function(event) {
                this.$.appscoAccountChat.toggleChat(event.target);
            },

            _onAccountSettingsAction: function(event) {
                this.set('routeData.page', 'account');
            },

            _onGetAccountResponse: function(event) {
                this.account = event.detail.response.account;
            },

            _searchApplications: function(event) {
                this.$.appscoHomePage.filterApplicationsByTerm(event.detail.term);
            },

            _onGroupSelected: function(event) {
                var id = parseInt(event.detail.id);

                switch(id) {
                    case 0:
                        this.applicationsApi = this.api.applications +"?extended=1";
                        break;
                    default:
                        this.applicationsApi = this.api.dashboards + "/" + id + "/icons";
                }

            },

            _onPageAnimationFinish: function(event) {
                var fromPage = event.detail.fromPage,
                    toPage = event.detail.toPage;

                switch(fromPage.getAttribute('name')) {
                    case 'home':
                        fromPage.hideInfo();
                        break;

                    case 'application':
                        fromPage.initializePage();
                        break;

                    case 'account':
                        fromPage.initializePage();
                        break;

                    default:
                        break;
                }

                switch(toPage.getAttribute('name')) {
                    case 'home':
                        toPage.setDefaultApplication();
                        break;

                    case 'application':
                        break;

                    default:
                        break;
                }

            },

            _onAccountAdvancedSettings: function() {
                this.$.appscoAccountPage.toggleAdvancedSettings();
            },

            _onAccountSettingsSaved: function() {
                this._notify('Account settings were successfully changed.');
            },

            _onAccountPasswordChanged: function() {
                this._notify('Account password was successfully changed.');
            },

            /**
             * Notifies application log api change.
             * Used to notify appsco-application-log to load log again.
             *
             * @param String applicationLogApi
             * @private
             */
            _notifyAboutApplicationLogChange: function(applicationLogApi) {
                this.set('application.meta.log', '');
                this.set('application.meta.log', applicationLogApi);
            },

            _notify: function(message) {
                this._toastMessage = message;
                this.$.toast.open();
            }
        });
    </script>
</dom-module>
