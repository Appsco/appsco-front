<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<link rel="import" href="../bower_components/appsco-header/appsco-header.html">
<link rel="import" href="../bower_components/appsco-header/appsco-account-chat.html">
<link rel="import" href="../bower_components/appsco-components/appsco-api.html">

<link rel="import" href="../bower_components/appsco-application/appsco-application-add.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-share.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-remove.html">
<link rel="import" href="../bower_components/appsco-application/appsco-application-subscriber-revoke.html">
<link rel="import" href="../bower_components/appsco-application/company/appsco-company-application-add.html">
<link rel="import" href="../bower_components/appsco-application/company/appsco-company-application-share.html">
<link rel="import" href="../bower_components/appsco-application/company/appsco-company-application-remove.html">
<link rel="import" href="../bower_components/appsco-application/company/appsco-application-orgunit.html">
<link rel="import" href="../bower_components/appsco-application/company/appsco-application-remove-orgunit.html">

<link rel="import" href="../bower_components/appsco-account/appsco-account-authorized-app-revoke.html">

<link rel="import" href="application/appsco-home-page-actions.html">
<link rel="import" href="application/appsco-application-page-actions.html">
<link rel="import" href="account/appsco-account-page-actions.html">
<link rel="import" href="upgrade/appsco-upgrade-page-actions.html">
<link rel="import" href="applications/appsco-applications-page-actions.html">
<link rel="import" href="applications/appsco-manage-application-page-actions.html">

<link rel="import" href="vault/appsco-vault-page-actions.html">
<link rel="import" href="vault/appsco-vault-manage-item.html">
<link rel="import" href="../bower_components/appsco-vault/appsco-vault-remove.html">

<link rel="import" href="../bower_components/appsco-orgunit/appsco-orgunit-modify.html">
<link rel="import" href="../bower_components/appsco-orgunit/appsco-orgunit-remove.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="webkit-scrollbar-style.html">

<dom-module id="appsco-app">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            /* Top header style START */
            appsco-header {
                height: 64px;
                padding: 16px 10px;
                box-sizing: border-box;
                color: #ffffff;
                background-color: var(--app-primary-color);

                --appsco-account-action-color: #ffffff;

                --appsco-brand: {
                     display: block;
                 };
                --appsco-product: {
                     height: 32px;
                     line-height: 35px;
                 };

                --paper-listbox: {
                     color: var(--app-secondary-color);
                 };

                --notifications-paper-card-header-text: {
                     color: var(--primary-text-color);
                 };
            }
            /* Top header style END */

            /* Bottom header style START */
            app-header {
                background-color: #ffffff;
                box-shadow: 0 3px 3px -2px rgba(0, 0, 0, 0.4);
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }
            app-header .actions {
                height: 100%;
            }
            .page-title {
                margin-right: 10px;
                font-size: 18px;
                color: var(--primary-text-color);
                text-transform: capitalize;
            }
            /* Bottom header style END */

            /* Menu list style START */
            .drawer-list {
            }
            .drawer-list > a,
            .drawer-list div[disabled],
            .drawer-list div[head]
            {
                display: block;
                padding: 0 16px;
                text-decoration: none;
                color: var(--app-secondary-color);
                line-height: 36px;
                border-bottom: 1px solid var(--divider-color);
                outline: none;
                font-size: 14px;
            }
            .drawer-list div[head] {
                background-color: var(--app-primary-color);
                color: #ffffff;
            }
            .drawer-list div[head].business {
                /*margin-top: 14px;*/
            }
            .drawer-list div[disabled] {
                opacity: 0.4;
            }
            .drawer-list a.iron-selected {
                background-color: var(--google-grey-300);
            }
            /* Menu list style END */

            :host app-drawer-layout[fullbleed] {
                top: 64px;
                overflow: hidden;
            }
            app-drawer {
                top: 64px;
                border-top: 1px solid #ffffff;
                height: calc(100vh - 64px);
                --app-drawer-content-container: {
                     padding-top: 0;
                     background: var(--body-background-color);
                 };
            }
            app-drawer iron-icon {
                --iron-icon-fill-color: var(--app-primary-color-dark);
            }
            app-toolbar {
                padding: 0 10px;
            }
            :host .flex-horizontal {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            :host .flex {
                @apply(--layout-flex);
            }
            .pages {
                height: 100%;
            }
            .menu-text {
                display: inline-block;
                vertical-align: middle;
                padding-left: 8px;
            }
            :host paper-progress {
                width: 100%;
                position: absolute;
                top: 64px;
                left: 0;
            }
            :host([tablet-screen]) {
                --appsco-paper-dialog: {
                     width: 90%;
                     top: 20vh;
                 };
            }
            :host([mobile-screen]) {
                --appsco-account-notifications-dropdown: {
                     width: 300px;
                 };

                --appsco-account-info-dropdown: {
                     width: 300px;
                 };
            }
            :host div[purchase] {
                margin-top: 20px;
                padding: 0 18px;
                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--paper-font-body1);
                color: var(--primary-text-color);
            }
            :host div[purchase] a {
                width: 100%;
            }
            :host div[purchase] paper-button {
                @apply(--primary-button);
                background-color: var(--success-color);
                border-color: var(--success-color);
                width: 100%;
                margin-top: 10px;
            }
            :host div[purchase] a {
                display: block;
                text-decoration: none;
                outline: none;
            }
        </style>

        <iron-media-query query="(max-width: 600px)" query-matches="{{ mobileScreen }}"></iron-media-query>
        <iron-media-query query="(max-width: 800px)" query-matches="{{ tabletScreen }}"></iron-media-query>

        <appsco-api id="api" domain="[[ domain ]]" index="" name="{{ api }}"></appsco-api>
        <app-location route="{{route}}"></app-location>

        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subroute}}"></app-route>

        <paper-toast id="toast" text="[[ _toastMessage ]]"></paper-toast>

        <appsco-header
                account="{{ account }}"
                brand-logo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAgCAYAAAB+ZAqzAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAVZJREFUeNrsmOENgjAQhcE4AG5QN2AERnCEjsAIdQJG6AiO0BEcATdwhLONxJR6V1u8Ij98ycXkrL3HR+8gVlWCAEDa0EjuaqP1csLGkPJ7FtlNR3hKIzknNeV0uC5YqzhNSc/AiORgKiyCnCbWSm5ar02DHEzFhyB3J9aCf/tL02qckSCvbHSAy60Va9BSSGFn1gAt1zjNlmj5Mr+gdYE0aXZahFmFdOgnSW5aEikivHmWo1NJWnoBLf8ItFujNWumErSwDs3V+xjJoNURtBTwSC6lZQrRmtXhoNXa6IFPIwctE3lYf3crv6TVER26Ki29RVpiNVoJkz+FlmGnlTD5Y7ROia82q9Iat0ALG5xyml3laUXMqkSKZWgRpiha4k+LMPYzWvuYsbquDxhFxn8fzmTt3DNnP9xVNgymbvbCj9SXu8zNeiZTUVocZ27pe/3HA/8QYABzJAP50CmRFwAAAABJRU5ErkJggg=="
                brand-logo-width="38"
                brand-logo-height="32"
                brand-title="AppsCo"
                authorization-token="[[ authorizationToken ]]"
                notifications-api="[[ api.notifications ]]"
                logout-api="[[ api.logout ]]"
                notifications-size="5"
                on-account-chat="_onAccountChat"
                on-account-settings="_onAccountSettingsAction"
                on-all-notifications="_onAllNotifications"></appsco-header>

        <app-drawer-layout fullbleed force-narrow>

             <!--Drawer content -->
            <app-drawer id="appDrawer">
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
                    <div head>
                        <span class="menu-text">Personal</span>
                    </div>
                    <a name="home" href="/home">
                        <iron-icon icon="icons:home"></iron-icon> <span class="menu-text">Home</span>
                    </a>
                    <a name="account" href="/account">
                        <iron-icon icon="icons:perm-identity"></iron-icon> <span class="menu-text">Account</span>
                    </a>
                    <a name="vault" href="/vault">
                        <iron-icon icon="icons:work"></iron-icon> <span class="menu-text">Vault</span>
                    </a>

                    <div head class="business">
                        <span class="menu-text">Business</span>
                    </div>
                    <a name="applications" href="/applications">
                        <iron-icon icon="icons:apps"></iron-icon> <span class="menu-text">Applications</span>
                    </a>
                    <div name="vault" href="/vault" disabled>
                        <iron-icon icon="icons:supervisor-account"></iron-icon> <span class="menu-text">Directory</span>
                        <!--icons:folder-shared-->
                    </div>
                    <div name="vault" href="/vault" disabled>
                        <iron-icon icon="icons:compare-arrows"></iron-icon> <span class="menu-text">Provisioning</span>
                    </div>
                    <div name="vault" href="/vault" disabled>
                        <iron-icon icon="icons:reorder"></iron-icon> <span class="menu-text">Audit</span>
                    </div>
                    <div name="vault" href="/vault" disabled>
                        <iron-icon icon="icons:donut-large"></iron-icon> <span class="menu-text">Statistics</span>
                        <!--icons:track-changes-->
                        <!--icons:trending-up-->
                    </div>
                    <div name="vault" href="/vault" disabled>
                        <iron-icon icon="icons:payment"></iron-icon> <span class="menu-text">Billing</span>
                    </div>
                    <div name="settings" href="/settings" disabled>
                        <iron-icon icon="icons:settings"></iron-icon> <span class="menu-text">Settings</span>
                    </div>

                    <div purchase name="upgrade" href="/upgrade">
                        <div>
                            Manage your business applications, employees and get meaningful insights.
                        </div>
                        <a href="/upgrade" name="upgrade">
                            <paper-button>Try Appsco Business</paper-button>
                        </a>
                    </div>
                </iron-selector>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header>
                    <app-toolbar class="flex-horizontal">
                        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                        <div class="page-title" condense-title>[[ _pageName ]]</div>

                        <neon-animated-pages
                                id="animatedActions"
                                class="actions flex flex-end"
                                selected="[[page]]"
                                attr-for-selected="name">

                            <appsco-home-page-actions
                                    name="home"
                                    authorization-token="[[ authorizationToken ]]"
                                    filter-api="[[ api.dashboards ]]?extended=1"
                                    on-add-application="_onAddApplication"
                                    on-search="_onSearchApplications"
                                    on-group-selected="_onGroupSelected"
                                    on-page-global-info="_onInfoAction"></appsco-home-page-actions>

                            <appsco-application-page-actions
                                    name="application"
                                    on-back="_backTo"
                                    on-resource-section="_onResourceActionApplicationPage"></appsco-application-page-actions>

                            <appsco-account-page-actions
                                    id="appscoAccountPageActions"
                                    name="account"
                                    on-back="_backTo"
                                    on-resource-section="_onResourceActionAccountPage"
                                    on-advanced-settings="_onAccountAdvancedSettings"></appsco-account-page-actions>

                            <appsco-vault-page-actions
                                    name="vault"
                                    authorization-token="[[ authorizationToken ]]"
                                    on-page-global-info="_onInfoVaultAction"
                                    on-add-vault-action="_onAddVaultAction"></appsco-vault-page-actions>

                            <appsco-upgrade-page-actions
                                    name="upgrade"
                                    authorization-token="[[ authorizationToken ]]"
                                    on-toggle-pricing="_onUpgradeTogglePricing"></appsco-upgrade-page-actions>

                            <appsco-applications-page-actions id="appscoApplicationsPageActions"
                                    name="applications"
                                    authorization-token="[[ authorizationToken ]]"
                                    filter-api="[[ api.dashboards ]]?extended=1"
                                    on-add-application="_onCompanyAddApplication"
                                    on-search="_onSearchApplications"
                                    on-page-global-info="_onInfoAction"
                                    on-page-global-filters="_onApplicationsFiltersAction"
                                    on-share="_onShareApplications"
                                    on-remove="_onRemoveApplications"
                                    on-orgunits="_onAddToOrgunit"
                                    on-select-all="_onSelectAllApplications"
                                    on-deselect-all="_onDeselectAllApplications"></appsco-applications-page-actions>

                            <appsco-manage-application-page-actions
                                    name="manage-application"
                                    on-back="_backTo"
                                    on-resource-section="_onResourceActionApplicationPage"></appsco-manage-application-page-actions>

                        </neon-animated-pages>

                    </app-toolbar>
                </app-header>

                <paper-progress id="pageProgress" indeterminate></paper-progress>

                <neon-animated-pages
                        class="pages"
                        selected="[[page]]"
                        attr-for-selected="name"
                        fallback-selection="404"
                        role="main"
                        on-neon-animation-finish="_onPageAnimationFinish">
                    <appsco-home-page
                            id="appscoHomePage"
                            name="home"
                            application="{{ application }}"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            applications-api="[[ applicationsApi ]]"
                            on-loaded="_onLoadedApplications"
                            on-edit-application="_onEditApplication"
                            on-info-edit-application="_onInfoEditApplication"
                            on-share-application="_onShareApplication"
                            on-filter-done="_onPageLoaded"
                            on-page-loaded="_onPageLoaded"></appsco-home-page>

                    <appsco-application-page
                            id="appscoApplicationPage"
                            name="application"
                            route="[[ subroute ]]"
                            application="{{ application }}"
                            applications-api="[[ api.icons ]]"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            accounts-api="[[ api.accounts ]]"
                            account="{{ account }}"
                            on-share-application="_onShareApplication"
                            on-remove-application="_onRemoveApplication"
                            on-subscription-revoke="_onSubscriptionRevoke"
                            on-application-settings-saved="_onApplicationSettingsSaved"
                            on-application-settings-no-changes="_onApplicationSettingsNoChanges"
                            on-autologin-changed="_onAutologinChanged"
                            on-error="_onError"
                            on-page-loaded="_onPageLoaded"></appsco-application-page>

                    <appsco-account-page
                            id="appscoAccountPage"
                            name="account"
                            account="{{ account }}"
                            authorization-token="[[ authorizationToken ]]"
                            notifications-api="[[ api.notifications ]]"
                            authorized-apps-api="[[ api.authorizedApps ]]"
                            log-api="[[ api.accountLog ]]"
                            two-fa-api="[[ api.twoFA ]]"
                            two-fa-qr-api="[[ api.twoFAQr ]]"
                            two-fa-codes-api="[[ api.twoFACodes ]]"
                            settings-api="[[ api.me ]]"
                            image-settings-api="[[ api.profileImage ]]"
                            transfer-token-api="[[ api.transferToken ]]"
                            change-password-api="[[ api.changePassword ]]"
                            partner-api="[[ api.partner ]]"
                            on-settings-saved="_onAccountSettingsSaved"
                            on-password-changed="_onAccountPasswordChanged"
                            on-revoke-authorized-application="_onRevokeAuthorizedApplication"
                            on-disable-advanced-settings="_onDisableAdvancedSettings"
                            on-enable-advanced-settings="_onEnableAdvancedSettings"
                            on-twofa-enabled="_onTwoFaEnabled"
                            on-twofa-disabled="_onTwoFaDisabled"
                            on-page-loaded="_onPageLoaded"></appsco-account-page>

                    <appsco-vault-page
                            id="appscoVaultPage"
                            name="vault"
                            authorization-token="[[ authorizationToken ]]"
                            api="[[ api ]]"
                            on-loaded="_onLoadedVaultItems"
                            on-edit="_onEditVaultAction"
                            on-remove-vault-item="_onRemoveVaultAction"
                            on-page-loaded="_onPageLoaded">
                    </appsco-vault-page>

                    <appsco-upgrade-page
                            id="appscoUpgradePage"
                            name="upgrade"
                            authorization-token="[[ authorizationToken ]]"
                            on-page-loaded="_onPageLoaded"
                    ></appsco-upgrade-page>

                    <appsco-applications-page
                            id="appscoApplicationsPage"
                            name="applications"
                            application="{{ application }}"
                            selected-applications="{{ _selectedApplications }}"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            computed-headers="[[ _computedHeaders ]]"
                            company-applications-api="[[ companyApplicationsApi ]]"
                            company-orgunits-api="[[ companyOrgunitsApi ]]"
                            on-loaded="_onLoadedApplications"
                            on-edit-application="_onEditApplication"
                            on-info-edit-application="_onInfoEditApplication"
                            on-share-company-application="_onShareCompanyApplication"
                            on-filter-done="_onPageLoaded"
                            on-page-loaded="_onPageLoaded"
                            on-show-bulk-actions="_onShowApplicationsBulkActions"
                            on-hide-bulk-actions="_onHideApplicationsBulkActions"
                            on-add-orgunit="_onAddOrgunit"
                            on-modify-orgunit="_onModifyOrgunit"
                            on-remove-orgunit="_onRemoveOrgunit"></appsco-applications-page>

                    <appsco-manage-application-page
                            id="appscoManageApplicationPage"
                            name="manage-application"
                            route="[[ subroute ]]"
                            application="{{ application }}"
                            company-api="[[ companyApi ]]"
                            application-log="[[ application.meta.log ]]"
                            authorization-token="[[ authorizationToken ]]"
                            accounts-api="[[ api.accounts ]]"
                            account="{{ account }}"
                            on-share-company-application="_onShareCompanyApplication"
                            on-remove-application="_onRemoveCompanyApplication"
                            on-subscription-revoke="_onSubscriptionRevoke"
                            on-application-settings-saved="_onApplicationSettingsSaved"
                            on-sharing-settings-saved="_onApplicationSettingsSaved"
                            on-application-settings-no-changes="_onApplicationSettingsNoChanges"
                            on-add-to-orgunit="_onAddApplicationToOrgunit"
                            on-remove-from-orgunit="_onRemoveApplicationFromOrgunit"
                            on-error="_onError"
                            on-page-loaded="_onPageLoaded"></appsco-manage-application-page>

                    <appsco-not-found-page name="404"></appsco-not-found-page>
                </neon-animated-pages>
            </app-header-layout>
        </app-drawer-layout>

        <appsco-account-chat
                id="appscoAccountChat"
                account="{{ account }}"
                chat="{{ chat }}"
                dont-close-outside>
        </appsco-account-chat>

        <appsco-application-add
                id="appscoApplicationAdd"
                authorization-token="[[ authorizationToken ]]"
                applications-template-api="[[ api.applicationTemplates ]]"
                dashboard-api="[[ addAppApi ]]"
                on-application-added="_onApplicationAdded"
                on-link-added="_onApplicationAdded">
        </appsco-application-add>

        <appsco-application-share
                id="appscoApplicationShare"
                application="[[ application ]]"
                authorization-token="[[ authorizationToken ]]"
                accounts-api="[[ api.accounts ]]"
                on-application-shared="_onApplicationShared"
                ></appsco-application-share>

        <appsco-application-remove
                id="appscoApplicationRemove"
                application="[[ application ]]"
                authorization-token="[[ authorizationToken ]]"
                on-application-removed="_onApplicationRemoved"></appsco-application-remove>

        <appsco-account-authorized-app-revoke
                id="appscoAccountAuthorizedAppRevoke"
                application="[[ _authorizedApplication ]]"
                authorization-token="[[ authorizationToken ]]"
                on-application-revoked="_onAuthorizedApplicationRevoked"></appsco-account-authorized-app-revoke>

        <appsco-application-subscriber-revoke
                id="appscoApplicationSubscriberRevoke"
                authorization-token="[[ authorizationToken ]]"
                on-subscription-revoked="_onSubscriptionRevoked"
        ></appsco-application-subscriber-revoke>

        <appsco-vault-remove
                id="appscoVaultItemRemove"
                authorization-token="[[ authorizationToken ]]"
                on-vault-item-removed="_onVaultItemRemoved"
        ></appsco-vault-remove>

        <appsco-vault-manage-item
                id="appscoVaultItemManage"
                authorization-token="[[ authorizationToken ]]"
                api="[[ api ]]"
                on-item-saved="_onItemSaved"
        ></appsco-vault-manage-item>

        <appsco-orgunit-modify
                id="appscoOrgunitModify"
                authorization-token="[[ authorizationToken ]]"
                on-orgunit-added="_onOrgunitAdded"
                on-orgunit-modified="_onOrgunitModified"
                ></appsco-orgunit-modify>

        <appsco-orgunit-remove
                id="appscoOrgunitRemove"
                authorization-token="[[ authorizationToken ]]"
                on-orgunit-removed="_onOrgunitRemoved"
                ></appsco-orgunit-remove>

        <appsco-company-application-add
                id="appscoCompanyApplicationsAdd"
                authorization-token="[[ authorizationToken ]]"
                applications-template-api="[[ api.applicationTemplates ]]"
                company-api="[[ companyApi ]]"
                on-applications-added="_onCompanyApplicationsAdded">
        </appsco-company-application-add>

        <appsco-application-orgunit
                id="appscoApplicationOrgunit"
                authorization-token="[[ authorizationToken ]]"
                company-orgunits-api="[[ companyOrgunitsApi ]]"
                applications="[[ _selectedApplications ]]"
                on-added-to-orgunit="_onAddedToOrgunit"></appsco-application-orgunit>

        <appsco-application-remove-orgunit
                id="appscoApplicationRemoveOrgunit"
                authorization-token="[[ authorizationToken ]]"
                application="[[ application ]]"
                on-application-removed-from-orgunit="_onApplicationRemovedFromOrgunit"></appsco-application-remove-orgunit>

        <appsco-company-application-share
                id="appscoCompanyApplicationsShare"
                applications="[[ _applicationsToShare ]]"
                authorization-token="[[ authorizationToken ]]"
                accounts-api="[[ api.accounts ]]"
                on-applications-shared="_onCompanyApplicationsShared"
                ></appsco-company-application-share>

        <appsco-company-application-remove
                id="appscoCompanyApplicationsRemove"
                applications="[[ _selectedApplications ]]"
                authorization-token="[[ authorizationToken ]]"
                company-api="[[ companyApi ]]"
                on-applications-removed="_onApplicationsRemoved"
                on-applications-remove-failed="_onApplicationsRemoveFailed"></appsco-company-application-remove>

        <template is="dom-if" if="[[ api.me ]]">
            <iron-ajax auto
                       url="[[ api.me ]]"
                       on-response="_onGetAccountResponse"
                       headers="{{ _computedHeaders }}"></iron-ajax>
        </template>

        <template is="dom-if" if="[[ api.dashboards ]]">
            <iron-ajax auto
                       url="[[ api.dashboards ]]?extended=1"
                       on-response="_onDashboardsResponse"
                       headers="{{ _computedHeaders }}"></iron-ajax>
        </template>

        <template is="dom-if" if="[[ api.companies ]]">
            <iron-ajax auto
                       url="[[ api.companies ]]"
                       on-response="_onCompaniesResponse"
                       headers="{{ _computedHeaders }}"></iron-ajax>
        </template>
    </template>

    <script>
        Polymer({
            is: 'appsco-app',

            properties: {

                _business: {
                    type: Boolean,
                    computed: '_computeBusiness(page)',
                    reflectToAttribute: true,
                    observer: '_onBusinessChange'
                },

                page: {
                    type: String,
                    observer: '_pageChanged'
                },

                domain: {
                    type: String
                },

                _pageName: {
                    type: String,
                    computed: '_computePageName(page)'
                },

                api: {
                    type: Object,
                    value: function () { return {}; },
                    notify: true
                },

                account: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    notify: true
                },

                /**
                 * Computed headers.
                 * It contains authorization token.
                 */
                _computedHeaders: {
                    type: Object,
                    computed: "_computeHeaders(authorizationToken)"
                },

                chat: {
                    type: Object,
                    value: function() {
                        return {
                            auth: "auth code",
                            room: "room number",
                            service: "https://www.xxx.com",
                            active: "false"
                        }
                    }
                },

                /**
                 * Selected application.
                 */
                application: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * Selected applications (company).
                 */
                _selectedApplications: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },

                /**
                 * Company applications to share.
                 */
                _applicationsToShare: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },

                /**
                 * Selected authorized application that is to be removed.
                 */
                _authorizedApplication: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    notify: true
                },

                /**
                 * Authorization token for logged account.
                 */
                authorizationToken: {
                    type: String,
                    value: ''
                },

                addAppApi: {
                    type: String,
                    value: ''
                },

                applicationsApi: {
                    type: String,
                    value: '',
                    notify: true
                },

                companyApplicationsApi: {
                    type: String,
                    value: ''
                },

                companyOrgunitsApi: {
                    type: String,
                    value: ''
                },

                companyApi: {
                    type: String,
                    value: ''
                },

                _globalActions: {
                    type: Boolean,
                    value: true
                },

                _toastMessage: {
                    type: String,
                    value: ''
                },

                mobileScreen: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },

                tabletScreen: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                }
            },

            observers: [
                '_updateScreen(mobileScreen, tabletScreen)',
                '_routePageChanged(routeData.page)'
            ],

            listeners: {
                'api-changed': "_apiChanged"
            },

            _onBusinessChange: function() {

                if (this._business) {
                    this.customStyle['--app-primary-color'] = '#5AC099';

                    // Without click new value of CSS variable doesn't apply to children components.
                    setTimeout(function() {
                        document.body.click();
                    }, 10);
                }
                else {
                    this.customStyle['--app-primary-color'] = '#279FBC';
                }

                this.updateStyles();

            },

            attached: function() {

                if (this.mobileScreen || this.tabletScreen) {
                    this.updateStyles();
                }

            },

            _updateScreen: function(mobile, tablet) {
                this.updateStyles();
            },

            _apiChanged: function() {
                this.applicationsApi = this.api.icons + "?extended=1";
            },

            /**
             * Routing START
             */
            _routePageChanged: function(page) {
                this.page = page || 'home';
            },

            _pageChanged: function(page) {

                this._setProgressBar(page);

                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('appsco-' + page + '-page.html');

                this.importHref(resolvedPageUrl, null, this._showPage404, true);

                this.$.appDrawer.close();
            },

            _computePageName: function(page) {

                switch (page) {
                    case 'manage-application':
                        return 'Manage Application';

                    default:
                        return page;
                }

            },

            _showHomePage: function() {
                this.set('routeData.page', 'home');
            },

            _showAccountPage: function() {
                this.set('routeData.page', 'account');
            },

            _showCompanyApplicationsPage: function() {
                this.set('routeData.page', 'applications');
            },

            _showPage404: function() {
                this.page = '404';
                this._pageName = 'Not Found';
            },

            _backTo: function() {
                this._business ? this._showCompanyApplicationsPage() : this._showHomePage();
            },
            /**
             * Routing END
             */

            /**
             * Ajax START
             */
            /**
             * Computes authorization headers.
             *
             * @param {Object} authorizationToken
             * @returns {{ Authorization: string }}
             * @private
             */
            _computeHeaders: function (authorizationToken) {
                return {
                    'Authorization': 'token ' + authorizationToken
                }
            },

            _onGetAccountResponse: function(event) {
                this.account = event.detail.response.account;
            },

            _onDashboardsResponse: function(event) {
                var response = event.detail.response;

                if (response && response.meta.total > 0) {
                    this.addAppApi = response.dashboards[0].self;
                }

            },

            _onCompaniesResponse: function(event) {
                var response = event.detail.response;

                if (response && response.meta.total > 0) {
                    this.companyApi = response.companies[0];
                    this.companyApplicationsApi = response.companies[0] + '/applications?extended=1';
                    this.companyOrgunitsApi = response.companies[0] + '/org-units?extended=1';
                }
            },
            /**
             * Ajax END
             */

            /**
             * Appsco header actions START
             */
            _onAccountChat: function(event) {
                this.$.appscoAccountChat.toggleChat(event.target);
            },

            _onAccountSettingsAction: function() {
                this._showAccountPage();
            },

            _onAllNotifications: function() {
                this.$.appscoAccountPage.showAllNotifications = true;
                this._showAccountPage();
            },
            /**
             * Appsco header actions END
             */

            /**
             * Home page START
             */
            _onLoadedApplications: function() {

                if (this.page === 'home') {
                    this.$.appscoHomePage.setDefaultApplication();
                }
                else if (this.page === 'applications') {
                    this.$.appscoApplicationsPage.setDefaultApplication();
                }

            },

            _onInfoAction: function() {
                this._business ?  this.$.appscoApplicationsPage.toggleInfo() : this.$.appscoHomePage.toggleInfo();
            },

            _onInfoVaultAction: function() {
                this.$.appscoVaultPage.toggleInfo();
            },

            _onSearchApplications: function(event) {
                var term = event.detail.term;

                this._showProgressBar();
                this._business ? this.$.appscoApplicationsPage.filterApplicationsByTerm(term) : this.$.appscoHomePage.filterApplicationsByTerm(term);
            },

            _onGroupSelected: function(event) {
                var id = parseInt(event.detail.id);

                this._showProgressBar();

                switch(id) {
                    case 0:
                        this.applicationsApi = this.api.icons +"?extended=1";
                        break;
                    default:
                        this.applicationsApi = this.api.dashboards + "/" + id + "/icons";
                }

            },

            _onAddApplication: function() {
                this.$.appscoApplicationAdd.toggle();
            },

            _onApplicationAdded: function(event) {
                var application = event.detail.application,
                    applications = [application],
                    message = application.title + ' was successfully saved.';

                this.$.appscoHomePage.addApplications(applications);
                this._notify(message);
            },

            _onEditApplication: function() {
                var routePath = this._business ? 'manage-application/' : 'application/';
                this.set('route.path', routePath + this.application.alias);
            },

            _onInfoEditApplication: function() {
                this._onEditApplication();
            },
            /**
             * Home page END
             */

            /**
             * Application page START
             */
            _onResourceActionApplicationPage: function() {
                this._business ? this.$.appscoManageApplicationPage.toggleResource() : this.$.appscoApplicationPage.toggleResource();
            },

            _onShareApplication: function() {
                this.$.appscoApplicationShare.toggle();
            },

            _onApplicationShared: function(event) {
                var application = event.detail.application,
                    applicationLogApi = application.meta.log,
                    message = 'You successfully shared ' + this.application.title + '.';

                // In order to notify.
                this.set('application', {});
                this.set('application', application);

                this._notifyAboutApplicationLogChange(applicationLogApi);
                this._notify(message);
            },

            _onRemoveApplication: function() {
                this.$.appscoApplicationRemove.open();
            },

            _onApplicationRemoved: function(event) {
                var application = event.detail.application,
                    applications = [application],
                    message = application.title + ' was successfully removed.';

                this.$.appscoHomePage.removeApplications(applications);
                this._showHomePage();

                this._notify(message);
            },

            _onApplicationSettingsSaved: function(event) {
                var application = event.detail.application,
                    applicationLogApi = application.meta.log,
                    message = application.title + ' was successfully changed.';

                this._reloadApplications();
                this._notifyAboutApplicationLogChange(applicationLogApi);
                this._notify(message);
            },

            _onApplicationSettingsNoChanges: function(event) {
                this._notify('No changes have been made to ' + event.detail.application.title + '.');
            },

            _onAutologinChanged: function() {
                this._reloadApplications();
            },

            _reloadApplications: function() {

                if (this.$.appscoHomePage.$) {
                    this.$.appscoHomePage.reloadApplications();
                }

            },

            /**
             * Notifies application log api change.
             * Used to notify appsco-application-log to load log again.
             *
             * @param String applicationLogApi
             * @private
             */
            _notifyAboutApplicationLogChange: function(applicationLogApi) {
                this.set('application.meta.log', '');
                this.set('application.meta.log', applicationLogApi);
            },

            _onSubscriptionRevoke: function(event) {
                this.$.appscoApplicationSubscriberRevoke.application =   event.detail.application;
                this.$.appscoApplicationSubscriberRevoke.revokeAccount = event.detail.account;

                this.$.appscoApplicationSubscriberRevoke.open();
            },

            _onSubscriptionRevoked: function(event) {
                this.set("application", {});
                this.set("application", event.detail.application);
                var msg = "You have successfully revoked access to " + event.detail.application.title + ' for ' + event.detail.account.name;
                this._notify(msg);
            },
            /**
             * Application page END
             */

            /**
             * Account page START
             */
            _onResourceActionAccountPage: function() {
                this.$.appscoAccountPage.toggleResource();
            },

            _onAccountAdvancedSettings: function() {
                this.$.appscoAccountPage._onAccountAdvancedSettings();
            },

            _onAccountSettingsSaved: function() {
                this._notify('Account settings were successfully changed.');
            },

            _onAccountPasswordChanged: function() {
                this._notify('Account password was successfully changed.');
            },

            _onRevokeAuthorizedApplication: function(event) {
                this._authorizedApplication = event.detail.application;
                this.$.appscoAccountAuthorizedAppRevoke.open();
            },

            _onAuthorizedApplicationRevoked: function(event) {
                var application = event.detail.application;

                this._authorizedApplication = {};
                this._notify(application.title + ' was successfully revoked.');
                this.$.appscoAccountPage.onApplicationRevoked();
            },

            _onDisableAdvancedSettings: function() {
                this.$.appscoAccountPageActions.disableAdvancedSettings();
            },

            _onEnableAdvancedSettings: function() {
                this.$.appscoAccountPageActions.enableAdvancedSettings();
            },

            _onTwoFaEnabled: function() {
                this._notify("Two-factor authentication enabled.")
            },

            _onTwoFaDisabled: function() {
                this._notify("Two-factor authentication disabled.")
            },
            /**
             * Account page END
             */

            /**
             * Vault page START
             */
            _onLoadedVaultItems: function() {

                if (this.page === 'vault') {
                    this.$.appscoVaultPage.setDefaultItem();
                }

            },

            _onAddVaultAction: function(event) {
                var appscoVaultItemManage = this.$.appscoVaultItemManage;

                appscoVaultItemManage.open(event.detail.action);
            },

            _onEditVaultAction: function(event) {
                var appscoVaultItemManage = this.$.appscoVaultItemManage;

                appscoVaultItemManage.set('item', event.detail.item);
                appscoVaultItemManage.open(event.detail.item.vaultType);
            },

            _onRemoveVaultAction: function(event) {
                var appscoVaultItemRemove = this.$.appscoVaultItemRemove;

                appscoVaultItemRemove.item = event.detail.item;
                appscoVaultItemRemove.open();
            },

            _onItemSaved: function(event) {
                var item = event.detail.item,
                    appscoVaultPage = this.$.appscoVaultPage;

                appscoVaultPage.item = item;
                appscoVaultPage.setItem(item);
                this._notify('Vault item ' + item.displayTitle + ' has been successfully saved.');
            },

            _onVaultItemRemoved: function(event) {
                var appscoVaultPage = this.$.appscoVaultPage;

                appscoVaultPage.removeItem(event.detail.item);
                appscoVaultPage.hideInfo();
                appscoVaultPage.setDefaultItem();
                this._notify('Vault item ' + event.detail.item.displayTitle + ' removed.');

            },
            /**
             * Vault page END
             */

            /**
             * Upgrade page START
             */
            _onUpgradeTogglePricing: function() {
                this.$.appscoUpgradePage.togglePricing();
            },
            /**
             * Upgrade page END
             */

            /**
             * Applications page START
             */
            _onApplicationsFiltersAction: function() {
                this.$.appscoApplicationsPage.toggleResource();
            },

            _onShowApplicationsBulkActions: function() {
                this.$.appscoApplicationsPageActions.showBulkActions();
            },

            _onHideApplicationsBulkActions: function() {
                this.$.appscoApplicationsPageActions.hideBulkActions();
            },

            _onAddOrgunit: function(event) {
                var orgunitAddDialog = this.$.appscoOrgunitModify;

                orgunitAddDialog.parent = event.detail.orgUnit;
                orgunitAddDialog.orgUnit = {};
                orgunitAddDialog.open();
            },

            _onOrgunitAdded: function(event) {
                var orgunit = event.detail.orgUnit;

                this.$.appscoApplicationsPage.addOrgunit(orgunit);
                this._notify('Organization unit ' + orgunit.name + ' successfully added.');
            },

            _onModifyOrgunit: function(event) {
                var orgunitModifyDialog = this.$.appscoOrgunitModify;

                orgunitModifyDialog.parent = {};
                orgunitModifyDialog.orgUnit = event.detail.orgUnit;
                orgunitModifyDialog.open();
            },

            _onOrgunitModified: function(event) {
                var orgunit = event.detail.orgUnit;

                this.$.appscoApplicationsPage.modifyOrgunit(orgunit);
                this._notify('Organization unit ' + orgunit.name + ' successfully modified.');
            },

            _onRemoveOrgunit: function(event) {
                var orgunitRemoveDialog = this.$.appscoOrgunitRemove;

                orgunitRemoveDialog.orgUnit = event.detail.orgUnit;
                orgunitRemoveDialog.open();
            },

            _onOrgunitRemoved: function(event) {
                var orgunit = event.detail.orgUnit;

                this.$.appscoApplicationsPage.removeOrgunit(orgunit);
                this._notify('Organization unit ' + orgunit.name + ' successfully removed.');
            },

            _onCompanyAddApplication: function() {
                this.$.appscoCompanyApplicationsAdd.toggle();
            },

            _onCompanyApplicationsAdded: function(event) {
                var applications = event.detail.applications,
                    message = 'Selected applications were successfully added.';

                this.$.appscoApplicationsPage.addApplications(applications);
                this._notify(message);
            },

            _onAddToOrgunit: function() {
                this.$.appscoApplicationOrgunit.toggle();
            },

            _onAddedToOrgunit: function(event) {
                var applications = event.detail.applications;

                this._notify('Selected applications were successfully added to ' + event.detail.orgunit.name + '.');

                if (this.$.appscoApplicationsPage.$) {
                    this.$.appscoApplicationsPage.modifyApplications(applications);
                }

                if (applications.length === 1) {
                    this.application = applications[0];
                }
            },

            _onShareApplications: function() {
                this.set('_applicationsToShare', this._selectedApplications);
                this.$.appscoCompanyApplicationsShare.toggle();
            },

            _onShareCompanyApplication: function(event) {
                this.set('_applicationsToShare', []);
                this._applicationsToShare.push(event.detail.application);
                this.$.appscoCompanyApplicationsShare.toggle();
            },

            _onCompanyApplicationsShared: function(event) {
                var applications = event.detail.applications,
                    application = applications[applications.length - 1];

                this.set('application', {});
                this.set('application', application);

                this._notify('Selected applications were successfully shared.');
            },

            _onRemoveApplications: function() {
                this.$.appscoCompanyApplicationsRemove.toggle();
            },

            _onApplicationsRemoved: function() {
                this.$.appscoApplicationsPage.removeApplications();
                this.set('selectedApplications', []);
                this._showCompanyApplicationsPage();
                this._notify('Selected applications were successfully removed from company.');
            },

            _onApplicationsRemoveFailed: function() {
                this.set('selectedApplications', []);
                this._notify('An error occurred. Selected applications were not removed from company. Please try again.');
            },

            _onSelectAllApplications: function() {
                this.$.appscoApplicationsPage.selectAllApplications();
            },

            _onDeselectAllApplications: function() {
                this.$.appscoApplicationsPage.deselectAllApplications();
                this._onHideApplicationsBulkActions();

            },

            _onRemoveCompanyApplication: function(event) {
                this.set('_selectedApplications', [event.detail.application]);
                this._onRemoveApplications();
            },

            _onAddApplicationToOrgunit: function(event) {
                this.set('_selectedApplications', [event.detail.application]);
                this._onAddToOrgunit();
            },

            _onRemoveApplicationFromOrgunit: function(event) {
                this.$.appscoApplicationRemoveOrgunit.orgunit = event.detail.orgunit;
                this.application = event.detail.application;
                this.$.appscoApplicationRemoveOrgunit.toggle();
            },

            _onApplicationRemovedFromOrgunit: function(event) {
                var application = event.detail.application;

                if (this.$.appscoApplicationsPage.$) {
                    this.$.appscoApplicationsPage.modifyApplications([application]);
                }

                this.application = application;

            },
            /**
             * Applications page END
             */

            /**
             * Global START
             */
            _setProgressBar: function(page) {

                switch (page) {
                    case 'home':
                        this.$.appscoHomePage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    case 'application':
                        this.$.appscoApplicationPage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    case 'account':
                        this.$.appscoAccountPage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    case 'vault':
                        this.$.appscoVaultPage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    case 'applications':
                        this.$.appscoApplicationsPage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    case 'manage-application':
                        this.$.appscoManageApplicationPage.pageLoaded ? this._hideProgressBar() : this._showProgressBar();
                        break;

                    default:
                        this._hideProgressBar();
                }

            },

            _onPageLoaded: function() {
                this._hideProgressBar();
            },

            _showProgressBar: function() {
                this.$.pageProgress.hidden = false;
            },

            _hideProgressBar: function() {

                setTimeout(function() {
                    this.$.pageProgress.hidden = true;
                }.bind(this), 1000);

            },

            _computeBusiness: function(page) {
                return (page === 'applications' || page === 'manage-application');
            },

            _onPageAnimationFinish: function(event) {
                var fromPage = event.detail.fromPage,
                    toPage = event.detail.toPage;

                switch(fromPage.getAttribute('name')) {
                    case 'home':
                        fromPage.hideInfo();
                        break;

                    case 'application':
                    case 'account':
                    case 'manage-application':
                        fromPage.initializePage();
                        break;

                    case 'applications':
                        this._onHideApplicationsBulkActions();
                        fromPage.initializePage();
                        break;

                    default:
                        break;
                }

                switch(toPage.getAttribute('name')) {
                    case 'home':
                    case 'applications':

                        if (toPage.$) {
                            toPage.setDefaultApplication();
                        }

                        break;

                    default:
                        break;
                }

            },

            _notify: function(message) {
                this._toastMessage = message;
                this.$.toast.open();
            },

            _onError: function() {
                this._showPage404();
            }
            /**
             * Global END
             */
        });
    </script>
</dom-module>
