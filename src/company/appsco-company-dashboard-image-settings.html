<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../components/components/appsco-loader.html">
<link rel="import" href="../components/components/appsco-upload-image-behavior.html">
<link rel="import" href="../components/components/appsco-upload-image-styles.html">

<dom-module id="appsco-company-dashboard-image-settings">
    <template>
        <style include="appsco-upload-image-styles">
        </style>

        <div class="upload-container">
            <appsco-loader active="[[ _loader ]]" loader-alt="AppsCo is processing request" multi-color></appsco-loader>

            <iron-image class="item-image"
                        src="[[ company.dashboard_image ]]"
                        alt="Company logo"
                        sizing="contain"></iron-image>

            <template is="dom-if" if="[[ !previewOnly ]]">
                <label for="dashboardImageInput"
                       class$="item-image-upload [[ _imagePreview ]]">
                    <iron-icon icon="file-upload" class="icon-upload"></iron-icon>
                </label>

                <input type="file"
                       accept="image/*"
                       id="dashboardImageInput"
                       name="company-image"
                       class="upload-file"
                       on-change="_onUploadImage">
            </template>
        </div>

        <template is="dom-if" if="[[ !previewOnly ]]">
            <template is="dom-if" if="[[ company.dashboard_image ]]">
                <paper-button class="remove-action"
                              on-tap="_onRemoveImageAction">Remove logo</paper-button>
            </template>
        </template>

    </template>
    <script>
        class AppscoCompanyDashboardImageSettings extends Polymer.mixinBehaviors([Polymer.AppscoUploadImageBehavior], Polymer.Element) {
            static get is() { return 'appsco-company-dashboard-image-settings'; }

            static get properties() {
                return {
                    company: {
                        type: Object,
                        value: function () {
                            return {}
                        },
                        notify: true
                    },

                    _imagePreview: {
                        type: String,
                        computed: '_computeImagePreviewClass(company)'
                    }
                };
            }

            reset() {
                const company = JSON.parse(JSON.stringify(this.company));

                this.set('company', {});
                this.set('company', company);
            }

            _computeImagePreviewClass(company) {
                return (company && company.dashboard_image) ? 'has-image' : 'no-image';
            }

            _setNewImage(file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    this._setObjectAttribute('company', 'dashboard_image', e.target.result);
                }.bind(this);

                reader.readAsDataURL(file);
            }

            _fireChangeEvent(response) {
                this.dispatchEvent(new CustomEvent('company-dashboard-logo-changed', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        company: JSON.parse(response)
                    }
                }));
            }

            _setStateAfterImageIsRemoved(response) {
                this.set('company', response);
                this._fireChangeEvent(JSON.stringify(response));
                this._hideLoader();
            }
        }
        window.customElements.define(AppscoCompanyDashboardImageSettings.is, AppscoCompanyDashboardImageSettings);
    </script>
</dom-module>
