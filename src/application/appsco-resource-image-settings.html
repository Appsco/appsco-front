<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../components/components/appsco-loader.html">
<link rel="import" href="../components/components/appsco-upload-image-behavior.html">
<link rel="import" href="../components/components/appsco-upload-image-styles.html">

<dom-module id="appsco-resource-image-settings">
    <template>
        <style include="appsco-upload-image-styles">
            :host .upload-container {
                width: 64px;
                height: 64px;
                @apply(--image-upload-container);
            }
        </style>

        <div class="upload-container">

            <appsco-loader active="[[ _loader ]]" loader-alt="AppsCo is processing request" multi-color></appsco-loader>

            <iron-image class="item-image"
                        src="[[ resource.application_url ]]"
                        alt="Resource image"
                        class="sized"
                        sizing="cover"></iron-image>

            <template is="dom-if" if="[[ !previewOnly ]]">
                <label for="imageInput"
                       class$="item-image-upload [[ _imagePreview ]]">
                    <iron-icon icon="file-upload" class="icon-upload"></iron-icon>
                </label>

                <input type="file"
                       accept="image/*"
                       id="imageInput"
                       name="resource-image"
                       class="upload-file"
                       on-change="_onUploadImage">
            </template>
        </div>

        <template is="dom-if" if="[[ !previewOnly ]]">
            <template is="dom-if" if="[[ resource.application_url ]]">
                <paper-button class="remove-action"
                              on-tap="_onRemoveImageAction">Reset icon</paper-button>
            </template>
        </template>

        <content select="[info]"></content>

    </template>
    <script>
        Polymer({

            is: 'appsco-resource-image-settings',

            properties: {
                /**
                 * resource to update.
                 */
                resource: {
                    type: Object,
                    value: function() {
                        return {}
                    },
                    notify: true
                },

                _imagePreview: {
                    type: String,
                    computed: '_computeImagePreviewClass(resource)'
                }
            },

            behaviors: [
                Polymer.AppscoUploadImageBehavior
            ],

            /**
             * Resets component.
             */
            reset: function() {
                var resource = JSON.parse(JSON.stringify(this.resource));

                this.set('resource', {});
                this.set('resource', resource);
            },

            _computeImagePreviewClass: function(resource) {
                return (resource && resource.application_url) ? 'has-image' : 'no-image';
            },

            _setNewImage: function(file) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    this._setObjectAttribute('resource', 'application_url', e.target.result);
                }.bind(this);

                reader.readAsDataURL(file);
            },

            _fireChangeEvent: function() {
                this.fire('resource-image-changed');
            },

            _setStateAfterImageIsRemoved: function(response) {
                this.set('resource', response);
                this._fireChangeEvent();
                this._hideLoader();
            }
        });
    </script>
</dom-module>
