<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<link rel="import" href="components/page/appsco-content.html">
<link rel="import" href="components/page/appsco-page-styles.html">
<link rel="import" href="components/application/appsco-application-info.html">
<link rel="import" href="components/application/appsco-application-analytics-security.html">
<link rel="import" href="components/application/appsco-application-analytics-info.html">
<link rel="import" href="components/application/appsco-application-log.html">
<link rel="import" href="components/orgunit/appsco-orgunit-tree.html">
<link rel="import" href="components/application/company/appsco-application-assignees.html">
<link rel="import" href="components/components/appsco-search.html">
<link rel="import" href="components/group/appsco-company-groups.html">
<link rel="import" href="components/application/company/appsco-company-resources.html">
<link rel="import" href="components/components/appsco-page-behavior.html">
<link rel="import" href="components/components/appsco-list-observer-behavior.html">

<dom-module id="appsco-resources-page">
    <template>
        <style include="appsco-page-styles">
            :host {

                --application-log-item: {
                     padding-bottom: 6px;
                     font-size: 14px;
                };

                --application-details-label: {
                    font-size: 12px;
                };
                --application-details-value: {
                    font-size: 14px;
                };
            }
            appsco-company-groups {
                margin-top: 20px;

                --appsco-company-group-item: {
                    padding: 4px;
                    margin-bottom: 5px;
                };
            }
            .resource-content {
                margin-top: 20px;
            }
            appsco-application-analytics-security {
                --security-score: {
                     width: 32px;
                     height: 32px;
                     font-size: 14px;
                 };
            }
            :host div[info] .details-log {
                height: calc(100% - 50px - 70px - 34px);
            }
            :host .details-log paper-tabs {
                height: 32px;
                @apply --layout-flex-none;
                color: var(--primary-text-color);
            }
            :host div[info] .info-details-section {
                margin-top: 10px;
                height: 100%;
            }
            .tab-content {
                margin-top: 20px;
                @apply --paper-tabs-content-style;
            }
            :host .info-actions > .view-button {
                margin-right: 1px;
            }
            appsco-application-share {
                --appsco-application-share-button: {
                     border-radius: 0;
                     margin: 0;
                     padding: 6px 12px;
                     background-color: var(--app-secondary-color);
                     color: #ffffff;
                     font-size: 14px;
                     height: 34px;
                 };
            }
            appsco-application-details {
                --appsco-application-icons-color: var(--primary-text-color);
            }
            :host *[content-top] {
                border-bottom: 1px solid var(--divider-color);
            }
            :host .content-top-content p:last-child {
                margin-bottom: 0;
            }
            :host([mobile-screen]) {
                --resource-width: 100%;
            }
        </style>

        <iron-media-query query="(max-width: 800px)" query-matches="{{ tabletScreen }}"></iron-media-query>
        <iron-media-query query="(max-width: 600px)" query-matches="{{ mobileScreen }}"></iron-media-query>

        <appsco-content id="appscoContent" resource-active>

            <template is="dom-if" if="[[ !resourceAdmin ]]">
                <div class="flex-vertical" resource slot="resource">
                    <div class="resource-header">
                        Groups
                    </div>

                    <div class="resource-content">
                        <appsco-search id="appscoSearch"
                                       label="Search groups"
                                       on-search="_onSearchGroups"
                                       on-search-clear="_onSearchGroupsClear"></appsco-search>

                        <appsco-company-groups id="appscoCompanyGroups"
                                               list-api="[[ groupsApi ]]"
                                               authorization-token="[[ authorizationToken ]]"
                                               size="100"
                                               type="group"
                                               preview
                                               on-item="_onGroupSelected"></appsco-company-groups>
                    </div>
                </div>
            </template>

            <div content-top slot="content-top">
                <div class="content-top-header">
                    Additional options
                </div>

                <template is="dom-if" if="[[ _hasSamlIdp ]]">
                    <div class="content-top-content">
                        <p>
                            Your company has set an Identity Provider.
                            You can add different related applications to your company's resources
                            and share them with your employees.
                            When they log in to AppsCo using their identities,
                            they will be automatically logged in to all related apps as well.
                        </p>
                        <p>
                            This page enables you to select and add the applications
                            based on the integrations your company has.
                        </p>
                    </div>
                    <div class="content-top-actions flex-horizontal flex-end">
                        <paper-button class="action"
                                      on-tap="_onEditAdditionalOptionsAction">
                            Edit
                        </paper-button>
                    </div>
                </template>

                <template is="dom-if" if="[[ !_hasSamlIdp ]]">
                    <div class="content-top-content">
                        <p>
                            There are no additional options available at this time.
                        </p>
                    </div>
                </template>
            </div>

            <div content slot="content">
                <div class="content-container">
                    <appsco-company-resources
                            id="appscoResources"
                            type="resource"
                            size="100"
                            min-search-term-length="2"
                            load-more
                            selectable
                            authorization-token="[[ authorizationToken ]]"
                            list-api="[[ companyResourcesApi ]]"
                            api-errors="[[ apiErrors ]]"
                            resource-admin="[[ resourceAdmin ]]"
                            on-item="_onResourceAction"
                            on-select-item="_onResourceSelectAction"
                            on-edit-item="_onResourceEditAction"
                            on-items-removed="_onResourcesRemoved"
                            on-list-loaded="_pageLoaded"
                            on-list-empty="_onResourcesEmptyLoad"
                            on-observable-list-empty="_onObservableItemListChange"
                            on-observable-list-filled="_onObservableItemListChange"></appsco-company-resources>
                </div>
            </div>

            <template is="dom-if" if="[[ !resourceAdmin ]]" restamp>
                <div class="flex-vertical" info slot="info">
                    <div class="info-header flex-horizontal">
                        <appsco-application-info class="flex"
                                                 application="[[ resource ]]"
                                                 company>
                        </appsco-application-info>

                        <appsco-application-analytics-security
                                application="[[ resource ]]"></appsco-application-analytics-security>
                    </div>

                    <div class="info-content">
                        <appsco-application-assignees id="appscoApplicationAssignees"
                                                      application="[[ resource ]]"
                                                      authorization-token="[[ authorizationToken ]]"
                                                      api-errors="[[ apiErrors ]]"
                                                      size="5"
                                                      preview
                                                      auto-load></appsco-application-assignees>

                        <div class="details-log flex-vertical">
                            <paper-tabs id="paperTabs" selected="{{ _selectedTab }}">
                                <paper-tab name="info">Info</paper-tab>
                                <paper-tab name="log">Log</paper-tab>
                            </paper-tabs>

                            <neon-animated-pages
                                    selected="{{ _selectedTab }}"
                                    entry-animation="fade-in-animation"
                                    exit-animation="fade-out-animation"
                                    class="info-details-section">

                                <div name="info" class="tab-content details">
                                    <appsco-application-analytics-info
                                            application="[[ resource ]]"></appsco-application-analytics-info>
                                </div>

                                <div name="log" class="tab-content log">
                                    <appsco-application-log
                                            application="[[ resource ]]"
                                            authorization-token="[[ authorizationToken ]]"
                                            company>
                                    </appsco-application-log>
                                </div>
                            </neon-animated-pages>
                        </div>
                    </div>

                    <div class="info-actions flex-horizontal">
                        <paper-button
                                class="button view-button flex"
                                on-tap="_onResourceInfoEdit">
                            Edit
                        </paper-button>

                        <paper-button
                                class="button secondary-button flex"
                                on-tap="_onShareResource">
                            Share
                        </paper-button>
                    </div>

                </div>
            </template>

        </appsco-content>

    </template>

    <script>
        class AppscoResourcesPage extends Polymer.mixinBehaviors([
            Polymer.NeonAnimatableBehavior,
            Polymer.AppscoPageBehavior,
            Polymer.AppscoListObserverBehavior
        ], Polymer.Element) {
            static get is() { return 'appsco-resources-page'; }

            static get properties() {
                return {
                    resource: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        notify: true
                    },

                    account: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    apiErrors: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    resourceAdmin: {
                        type: Boolean,
                        value: false
                    },

                    _orgUnits: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    _bulkActions: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    _infoShown: {
                        type: Boolean,
                        value: false
                    },

                    _selectedTab: {
                        type: Number
                    },

                    authorizationToken: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Computed headers.
                     * It contains authorization token.
                     */
                    computedHeaders: {
                        type: Object,
                        value: function () {
                            return {};
                        }
                    },

                    companyResourcesApi: {
                        type: String
                    },

                    getCompanyIdpConfigListApi: {
                        type: String
                    },

                    _hasSamlIdp: {
                        type: Boolean,
                        value: false
                    },

                    _resourceSelectAction: {
                        type: Number,
                        value: 0
                    },

                    mobileScreen: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },

                    tabletScreen: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },

                    animationConfig: {
                        type: Object
                    },

                    pageLoaded: {
                        type: Boolean,
                        value: false
                    },

                    groupsApi: {
                        type: String
                    },

                    _selectedFilter: {
                        type: Number,
                        value: 0,
                        observer: '_onSelectedFilterChanged'
                    },

                    pageConfig: {
                        type: Object,
                        value: function () {
                            return {};
                        },
                        observer: '_onPageConfigChanged'
                    }
                };
            }

            static get observers() {
                return [
                    '_getHasSamlIdpRequest(getCompanyIdpConfigListApi, authorizationToken)',
                    '_updateScreen(mobileScreen, tabletScreen)',
                    '_hideFilters(mobileScreen)'
                ];
            }

            ready() {
                super.ready();

                this.pageLoaded = false;
                this.animationConfig = {
                    'entry': {
                        name: 'fade-in-animation',
                        node: this,
                        timing: {
                            duration: 300
                        }
                    },
                    'exit': {
                        name: 'fade-out-animation',
                        node: this,
                        timing: {
                            duration: 200
                        }
                    }
                };
                Polymer.RenderStatus.beforeNextRender(this, function() {
                    if (this.mobileScreen || this.tabletScreen) {
                        this.updateStyles();
                    }
                });

                Polymer.RenderStatus.afterNextRender(this, function() {
                    this.set('_itemsComponent', this.$.appscoResources);
                });
            }

            _updateScreen(mobile, tablet) {
                this.updateStyles();
            }

            _hideFilters(mobile) {
                if (mobile) {
                    this.hideResource();
                }
            }

            _pageLoaded() {
                this.pageLoaded = true;
                this.dispatchEvent(new CustomEvent('page-loaded', { bubbles: true, composed: true }));
            }

            initializePage() {
                this.setDefaultResource();
                this._getHasSamlIdpRequest(this.getCompanyIdpConfigListApi, this.authorizationToken);
            }

            pageSelected () {
                this.reloadResources();
            }

            resetPage() {
                this._deselectAllItems();
                this.$.appscoResources.reset();
                this._resetFilters();
                this._resetPageActions();
                this.hideInfo();
            }

            removeResourceAssignee(resource, assignee) {
                if (resource.alias === this.resource.alias) {
                    this.shadowRoot.getElementById('appscoApplicationAssignees').removeAssignee(assignee);
                }
            }

            _onObservableItemListChange(event, data) {
                if(data.type === 'resources') {
                    this.setObservableType('resources-page');
                    this.populateItems(data.items);
                }
                event.stopPropagation();
            }

            _onResourcesEmptyLoad() {
                this.hideInfo();
                this._pageLoaded();
            }

            _showInfo() {
                this.$.appscoContent.showSection('info');
                this._infoShown = true;
                this._selectedTab = 0;
            }

            hideInfo() {
                this.$.appscoContent.hideSection('info');
                this._infoShown = false;
                this.$.appscoResources.deactivateItem(this.resource);
            }

            toggleInfo() {
                if (this.$.appscoResources.getAllItems().length > 0) {
                    this.$.appscoContent.toggleSection('info');
                    this._infoShown = !this._infoShown;

                    if (this._infoShown) {
                        this._selectedTab = 0;
                    }
                    else {
                        this.$.appscoResources.deactivateItem(this.resource);
                        this.setDefaultResource();
                    }
                }

            }

            toggleResource() {
                this.$.appscoContent.toggleSection('resource');
            }

            hideResource() {
                this.$.appscoContent.hideSection('resource');
            }

            toggleAdditionalOptions() {
                this.$.appscoContent.toggleSection('content-top');
            }

            _onPageConfigChanged(newValue) {
                newValue = newValue[this.getAttribute('name')];

                if (!newValue) {
                    return;
                }

                var appscoResourcesComponent = this.$.appscoResources;

                if (newValue.hide_resource_section) {
                    this.$.appscoContent.hideSection('resource')
                } else {
                    this.$.appscoContent.showSection('resource')
                }

                if (newValue.display_style) {
                    appscoResourcesComponent.setDisplayStyle(newValue.display_style);
                }

                if (newValue.sort_field && 'undefined' !== typeof newValue.sort_ascending) {
                    appscoResourcesComponent.setSort({
                        orderBy: newValue.sort_field,
                        ascending: newValue.sort_ascending
                    });
                }
            }

            _showBulkActions() {
                this.dispatchEvent(new CustomEvent('show-bulk-actions', { bubbles: true, composed: true }));
            }

            _hideBulkActions() {
                this.dispatchEvent(new CustomEvent('hide-bulk-actions', { bubbles: true, composed: true }));
            }

            _resetPageActions() {
                this.dispatchEvent(new CustomEvent('reset-page-actions', { bubbles: true, composed: true }));
            }

            addGroup(group) {
                this.shadowRoot.getElementById('appscoCompanyGroups').addItems([group]);
            }

            removeGroup(group) {
                this.shadowRoot.getElementById('appscoCompanyGroups').removeItems([group]);
            }

            _handleResourceInfo(resource) {
                this.set('resource', resource);

                if (!this._infoShown) {
                    this._showInfo();
                }
            }

            _onViewResourceInfo(event) {
                this._handleResourceInfo(event.detail.item);
            }

            _onResourceEditAction(event) {
                this.set('resource', event.detail.item);
                this.dispatchEvent(new CustomEvent('edit-resource', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        resource: event.detail.item
                    }
                }));
            }

            _onResourceInfoEdit() {
                this.dispatchEvent(new CustomEvent('info-edit-resource', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        resource: this.resource
                    }
                }));
            }

            _onResourceAction(event) {
                if (!this.resourceAdmin) {
                    if (event.detail.item.activated) {
                        this._onViewResourceInfo(event);
                    }
                    else {
                        this.hideInfo();
                        this.setDefaultResource();
                    }
                }
            }

            _onResourceSelectAction(event) {
                var resource = event.detail.item;

                clearTimeout(this._resourceSelectAction);

                this._resourceSelectAction = setTimeout(function() {
                    if (resource.selected) {
                        this._showBulkActions();
                    }
                    else {
                        var selectedResource = this.$.appscoResources.getFirstSelectedItem();
                        for (let key in selectedResource) {
                            return false;
                        }
                        this._hideBulkActions();
                    }
                }.bind(this), 10);

                this._handleItemsSelectedState();
            }

            _onShareResource() {
                this.dispatchEvent(new CustomEvent('share-company-resource', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        resource: this.resource
                    }
                }));
            }

            reloadResources() {
                this.$.appscoResources.reloadItems();
            }

            addResources(resources) {
                this.$.appscoResources.addItems(resources);

                if (!this.resource) {
                    this.set('resource', resources[resources.length - 1]);
                }
            }

            modifyResources(resources) {
                this.$.appscoResources.modifyItems(resources);
            }

            removeResources(resources) {
                this.$.appscoResources.removeItems(resources);
                this.setDefaultResource();
            }

            getSelectedResources() {
                return this.$.appscoResources.getSelectedItems();
            }

            _onResourcesRemoved() {
                this._hideBulkActions();
                this.setDefaultResource();
            }

            setDefaultResource() {
                this.set('resource', this.$.appscoResources.getFirstItem());
            }

            filterResourcesByTerm(term) {
                this.$.appscoResources.filterByTerm(term);
            }

            resetListFilters() {
                this._resetFilters();
                this.shadowRoot.getElementById('appscoSearch').reset();
                this._resetPageActions();
            }

            _onSelectedFilterChanged() {
                if (this.pageLoaded) {
                    this.resetPage();
                }
            }

            _resetFilters() {
                if (this.shadowRoot.getElementById('appscoCompanyGroups')) {
                    this.shadowRoot.getElementById('appscoCompanyGroups').reset();
                }
            }

            _searchGroups(term) {
                this.shadowRoot.getElementById('appscoCompanyGroups').filterByTerm(term);
            }

            _onSearchGroups(event) {
                this._searchGroups(event.detail.term);
            }

            _onSearchGroupsClear() {
                this.shadowRoot.getElementById('appscoSearch').reset();
                this._searchGroups('');
            }

            _loadResourcesForGroup(group) {
                this.$.appscoResources.filterByGroup(group);
            }

            _onGroupSelected(event) {
                this._loadResourcesForGroup(event.detail.item);
            }

            _onEditAdditionalOptionsAction() {
                this.dispatchEvent(new CustomEvent('edit-additional-options', { bubbles: true, composed: true }));
            }

            _getHasSamlIdpRequest(api, token) {
                if (!api || !token) {
                    this._hasSamlIdp = false;
                    return false;
                }

                var request = document.createElement('iron-request'),
                    options = {
                        url: api,
                        method: 'GET',
                        handleAs: 'json',
                        headers: {
                            'Authorization': 'token ' + token
                        }
                    };

                request.send(options).then(function() {
                    this._hasSamlIdp = (200 == request.status && (0 < request.response.meta.total));
                }.bind(this), function() {
                    this._hasSamlIdp = false;
                }.bind(this));
            }
        }
        window.customElements.define(AppscoResourcesPage.is, AppscoResourcesPage);
    </script>
</dom-module>
