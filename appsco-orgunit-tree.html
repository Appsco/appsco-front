<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">

<link rel="import" href="appsco-orgunit-item.html">


<!--
`appsco-orgunit-tree`
Representation of organization unit item

    <appsco-orgunit-tree>
    </appsco-orgunit-tree>

### Styling

`<appsco-orgunit-tree>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--appsco-orgunit-tree` | Mixin for the root element | `{}`

@demo demo/appsco-orgunit-tree.html
-->

<dom-module id="appsco-orgunit-tree">
    <template>
        <style>
            :host {
                display: block;
            @apply(--appsco-orgunit-tree);
            }
            :host .flex {
            @apply(--layout-flex);
            }
            :host .layout-horizontal {
            @apply(--layout-horizontal);
            }
            :host appsco-orgunit-item {
                margin-left: -4px;
            }
            :host iron-icon {
                transition: transform 0.2s linear;
                cursor: pointer;
            }
            :host iron-icon[opened] {
                transform: rotate(180deg);
                transition: transform 0.3s linear;
            }
            :host .node-icon {
                width: 24px;
            }
            :host .node {
                margin: 5px 0;
            }
            :host .child-node-1 {
                margin: 0 0 0 16px;
            }
        </style>

        <template is="dom-repeat" items="{{ _treeNodes }}" id="tree" index-as="rootIndex">
            <div class="layout-horizontal">
                <div class="node-icon">
                    <template is="dom-if" if="[[ _hasChildren(item.children) ]]">
                        <iron-icon icon="icons:expand-more" on-tap="_toggleOptions" for$="root_[[ rootIndex ]]"></iron-icon>
                    </template>
                </div>
                <div class="parent-node flex">
                    <appsco-orgunit-item org-unit="{{ item }}" modify add$="[[ _addAction ]]"></appsco-orgunit-item>
                    <div id$="root_[[ rootIndex ]]" class="node-container" hidden>
                        <template is="dom-repeat" items="{{ item.children }}" as="child" index-as="childIndex">
                            <div class="layout-horizontal node">
                                <div class="node-icon">
                                    <template is="dom-if" if="[[ _hasChildren(child.children) ]]">
                                        <iron-icon icon="icons:expand-more" on-tap="_toggleOptions" for$="child_[[ childIndex ]]"></iron-icon>
                                    </template>
                                </div>
                                <div class="child-node flex">
                                    <appsco-orgunit-item org-unit="{{ child }}" modify add$="[[ _addAction ]]" remove></appsco-orgunit-item>
                                    <div id$="child_[[ childIndex ]]" class="node-container" hidden>
                                        <template is="dom-repeat" items="{{ child.children }}" as="child1">
                                            <div class="child-node-1 node flex" >
                                                <appsco-orgunit-item org-unit="{{ child1 }}" modify remove></appsco-orgunit-item>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </template>

    <script>
        Polymer({

            is: 'appsco-orgunit-tree',

            properties: {
                _treeNodes: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    notify: true
                },

                /**
                 * [OrgUnit]() that is to be rendered
                 */
                orgUnits: {
                    type: Array,
                    value: function () {
                        return [];
                    },
                    notify: true
                },

                /**
                 * Number of organization units allowed.
                 */
                size: {
                    type: Number,
                    value: 100
                },

                multipleSelect: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates id Add Org Unit action should be available or not.
                 */
                _addAction: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Animation for loader appearance.
                 */
                animationConfig: {
                    value: function() {
                        return {
                            'entry': {
                                name: 'scale-up-animation',
                                axis: 'y',
                                transformOrigin: '0 0',
                                timing: {
                                    duration: 300
                                }
                            },
                            'exit': {
                                name: 'scale-down-animation',
                                axis: 'y',
                                transformOrigin: '0 0',
                                timing: {
                                    duration: 200
                                }
                            }
                        }
                    }
                }
            },

            behaviors: [
                Polymer.NeonAnimationRunnerBehavior
            ],

            listeners: {
                "selected": "_selectedNode",
                'neon-animation-finish': '_onAnimationFinish'
            },

            observers: [
                "orgUnitsChanged(orgUnits.*)"
            ],

            _computeAddAction: function() {
                this._addAction = this.orgUnits.length < this.size;
            },

            _toggleOptions: function(e) {
                var target = e.target,
                        item = target.getAttribute('for'),
                        dom = Polymer.dom(this.root).querySelector('#'+item);

                this.animationConfig.entry.node = null;
                this.animationConfig.exit.node = null;

                this.animationConfig.entry.node = dom;

                if (dom.hidden) {
                    dom.style.display = 'block';
                    this.playAnimation('entry');
                }
                else {
                    this.animationConfig.exit.node = dom;
                    this.playAnimation('exit');
                }

                dom.hidden ? target.setAttribute('opened', true) : target.removeAttribute('opened');
                dom.hidden = !dom.hidden;
            },

            _onAnimationFinish: function() {

                if (this.animationConfig.exit.node) {
                    this.animationConfig.exit.node.style.display = 'none';
                }

            },

            _hasChildren: function(arr) {
                return arr.length > 0;
            },

            orgUnitsChanged: function() {
                this._computeAddAction();
                this._treeNodes = [];
                this._treeNodes = JSON.parse(JSON.stringify(this.unflatten(this.orgUnits)));
            },

            unflatten: function (arr) {
                var tree = [],
                        mappedArr = {},
                        arrElem,
                        mappedElem;

                // First map the nodes of the array to an object -> create a hash table.
                for(var i = 0, len = arr.length; i < len; i++) {
                    arrElem = arr[i];
                    mappedArr[arrElem.self] = arrElem;
                    mappedArr[arrElem.self]['children'] = [];
                }
                for (var id in mappedArr) {
                    if (mappedArr.hasOwnProperty(id)) {
                        mappedElem = mappedArr[id];
                        // If the element is not at the root level, add it to its parent array of children.
                        if (mappedElem.parent) {
                            mappedArr[mappedElem['parent']]['children'].push(mappedElem);
                        }
                        // If the element is at the root level, add it to first level elements array.
                        else {
                            tree.push(mappedElem);
                        }
                    }
                }
                return tree;
            },

            _selectedNode: function(e) {
                var orgUnit = e.detail.orgUnit;
                if(!this.multipleSelect) {
                    Polymer.dom(this.root).querySelectorAll('appsco-orgunit-item').forEach(function (item) {
                        if (item.orgUnit.alias != orgUnit.alias) {
                            item.deSelect();
                        }
                    });
                }
                this.fire('node-selected', {
                    orgUnit: orgUnit,
                    selected: e.detail.selected
                })
            },

            selectedNodes: function() {
                var selectedNodes = [];
                Polymer.dom(this.root).querySelectorAll('appsco-orgunit-item').forEach(function (item) {
                    if (item.selected) {
                        selectedNodes.push(item.orgUnit);
                    }
                });

                return selectedNodes;
            },

            addOrgunit: function(orgunit) {
                this.push('orgUnits', orgunit);
            },

            /**
             * Finds orgunit in list and modifies it.
             * If item doesn't exist it adds item to the list.
             *
             * @param orgunit
             */
            setOrgunit: function(orgunit) {
                var orgunits = JSON.parse(JSON.stringify(this.orgUnits)),
                        length = orgunits.length;

                for (var i = 0; i < length; i++) {
                    var currentOrgunit = orgunits[i];

                    if (currentOrgunit.self === orgunit.self) {
                        orgunits[i] = orgunit;
                        this.set('orgUnits', []);
                        this.set('orgUnits', orgunits);
                        break;
                    }
                }
            },

            removeOrgunit: function(orgunit) {
                var index = this.orgUnits.indexOf(orgunit);
                this.splice('orgUnits', index, 1);
            }
        });
    </script>
</dom-module>
