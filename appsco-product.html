<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

<link rel="import" href="appsco-dropdown.html">

<!--
`appsco-product`
This component displays AppsCo product. If there is only one product it is displayed as text.
Otherwise, it is displayed as dropdown from which user can choose AppsCo Product: AppsCo or AppsCo Partner.

Example:

    <body>
      <appsco-product partner></appsco-product>


### Styling

`<appsco-product>` provides the following custom mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--appsco-light-background-color` | Background color used for SEE ALL action | `#f5f8fa`
`--border-color` | Border for products. | Based on border-color from theme.
`--appsco-product` | Mixin applied to root appsco-product element. | `{}`
`--appsco-product-dropdown` | Mixin applied to inner appsco-dropdown element. | `{}`

@demo demo/appsco-product.html
-->

<dom-module id="appsco-product">
    <template>
        <style>
            :host {
                display: inline-block;
                font-size: 16px;
                position: relative;

            @apply(--appsco-product);
            }
            :host .product-list-action {
                cursor: pointer;
            }
            :host appsco-dropdown {
                min-width: 160px;
                width: auto;
                top: 25px;
                right: -9px;

            @apply(--appsco-product-dropdown);
            }
            :host paper-listbox {
                padding: 0;
            }
            :host paper-listbox paper-item {
                cursor: pointer;
                height: 36px;
                font-size: 14px;
            }
        </style>

        <template is="dom-if" if="[[ _multiProducts ]]"
                  on-dom-change="_onMultiProductsChanged">

            <div id="triggerDropdown"
                 class="product-active product-list-action"
                 on-tap="_toggleProductDropdown">
                [[ _selectedProduct.label ]]
                <iron-icon icon="arrow-drop-down"></iron-icon>
            </div>

            <appsco-dropdown
                    open="{{ _pressed }}"
                    trigger="[[ _triggerDropdown ]]">

                <paper-listbox id="productList"
                               selected="[[ _selectedProduct.value ]]"
                               attr-for-selected="value"
                               on-iron-activate="_onItemActivate">

                    <template is="dom-repeat" items="[[ _products ]]">
                        <paper-item
                                value="[[ item.value ]]"
                                name="[[ item.name ]]"
                                label="[[ item.label ]]"
                                company="[[ item.company ]]"
                        >
                            [[ item.label ]]
                            <paper-ripple></paper-ripple>
                        </paper-item>
                    </template>

                </paper-listbox>

            </appsco-dropdown>


        </template>

        <template is="dom-if" if="[[ !_multiProducts ]]">

            <span class="product-active">
                [[ _selectedProduct.label ]]
            </span>

        </template>

    </template>

    <script>
        Polymer({

            is: 'appsco-product',

            properties: {

                /** Indicates if user has access to Appsco Partner product. */
                partner: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    observer: '_onPartnerChanged'
                },

                /** Indicates if user has access to Appsco Business product. */
                business: {
                    type: Array,
                    value: function() { return []; },
                    notify: true,
                    observer: '_onBusinessChanged'
                },

                /** Appsco products. */
                _products: {
                    type: Array,
                    value: function() {
                        return [{
                            label: 'Personal',
                            value: 'appsco-product',
                            name: 'appsco-product',
                            company: null
                        }];
                    }
                },

                _productToSelect: {
                    type: String
                },

                _selectedProduct: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                _multiProducts: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates if user clicked on element or not.
                 */
                _pressed: {
                    type: Boolean,
                    value: false,
                    notify: true
                },

                /**
                 * DOM element which triggers the dropdown.
                 */
                _triggerDropdown: {
                    type: Object,
                    notify: true
                }

            },

            attached: function() {

                this.set('_selectedProduct', this._products[0]);

                if (this.partner || this.business) {
                    this._multiProducts = true;
                }

                this._onPartnerChanged(this.partner);
                this._onBusinessChanged(this.business);
            },

            setProduct: function(product) {
                var products = this._products,
                        length = products.length;

                this.set('_productToSelect', product);

                for (var i = 0; i < length; i++) {
                    if (product === products[i].value) {
                        this.set('_selectedProduct', products[i]);
                    }
                }
            },

            _onPartnerChanged: function(partner) {

                if (this._products && partner) {

                    this.push('_products', {
                        label: 'Partner',
                        value: 'appsco-partner-product',
                        name: 'appsco-partner-product',
                        company: null
                    });

                    this._multiProducts = true;
                    this.setProduct(this._productToSelect);
                }

            },

            _onBusinessChanged: function(business) {

                if (this._products && business && business.length > 0) {
                    for(var i=0; i < business.length; i++) {
                        this.push('_products', {
                            label: business[i].company.name,
                            value: 'appsco-business-product'+business[i].company.alias,
                            name: 'appsco-business-product',
                            company: business[i]
                        });
                    }

                    this._multiProducts = true;
                    this.setProduct(this._productToSelect);
                }

            },

            _onMultiProductsChanged: function() {

                if (this._multiProducts) {
                    this._triggerDropdown = this.$$('#triggerDropdown');
                }

            },

            /**
             * Listens to iron-activate event of product list.
             * It sets label of selected product to display.
             * It fires event that product is changed: appsco-product-changed.
             *
             * @private
             */
            _onItemActivate: function(event) {
                var item = {};

                this.$$('#productList').select(event.detail.selected);

                item = this.$$('#productList').selectedItem;

                this._selectedProduct = item;

                this.fire('appsco-product-changed', {
                    product: item.name,
                    company: item.company
                });

                this._pressed = false;

            },

            /**
             * Toggles dropdown with product list.
             *
             * @private
             */
            _toggleProductDropdown: function() {
                this._pressed = !this._pressed;
            }

        });
    </script>
</dom-module>
