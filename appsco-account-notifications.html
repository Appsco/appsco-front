<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/social-icons.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="appsco-dropdown.html">
<link rel="import" href="appsco-account-notification.html">
<link rel="import" href="appsco-loader.html">

<!--
`appsco-account-notifications`
Is used to present notifications action.

Example:

    <body>
      <appsco-account-notifications>
     </appsco-account-notifications>

 Custom property | Description | Default
----------------|-------------|----------
`--primary-text-color` | Default text color for element | `Based on default theme --primary-text-color`
`--border-color` | Default border color | `Based on default theme --border-color`
`--divider-color` | Color for divider used for border of root element | `Based on default theme --divider-color`
`--appsco-account-action-color` | Color for icon-button action | `Based on --primary-text-color`
`--appsco-account-new-notifications-color` | Color for icon-button action when there are new notifications | `Based on --primary-text-color`
`--appsco-account-notifications` | Mixin applied to root appsco-account-notifications element | `{}`
`--appsco-account-notifications-dropdown` | Mixin applied to inner appsco-dropdown within root element | `{}`
`--appsco-account-active-action` | Mixin applied to action in active state | `{}`

@demo demo/appsco-account-notifications.html
-->

<dom-module id="appsco-account-notifications">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: inline-block;
                position: relative;
                color: var(--primary-text-color);

                @apply(--appsco-account-notifications);
            }
            :host .action-icon {
                color: var(--appsco-account-action-color, --primary-text-color);
                --paper-icon-button-ink-color: var(--appsco-account-action-color, --primary-text-color);
            }
            :host[_pressed] .action-icon {
                border-radius: 50%;

                @apply(--shadow-elevation-2dp);
                @apply(--appsco-account-active-action);
            }
            :host .new-notifications-icon {
                color: var(--appsco-account-new-notifications-color, --primary-color);
                --paper-icon-button-ink-color: var(--appsco-account-new-notifications-color, --primary-color);
            }
            :host .divider {
                width: 100%;
                height: 1px;
                background-color: var(--divider-color);
            }
            :host appsco-account-notification {
                color: var(--primary-text-color, #8398b1);
            }
            :host appsco-dropdown {
                top: 45px;
                min-height: 300px;

                @apply(--appsco-account-notifications-dropdown);
            }
            :host paper-card {
                width: 100%;
                min-height: 300px;

                --paper-card-header-color: var(--primary-text-color, #8398b1);

                --paper-card-header-text: {
                     font-size: 20px;
                 };
                --paper-card-actions: {
                     padding: 0;
                 };
            }
            :host paper-card .card-content-notifications {
                padding: 0;
            }
            :host paper-button {
                @apply(--paper-font-button);

                line-height: normal;
            }
            :host .default-btn {
                background-color: transparent;
                color: var(--primary-text-color);
                border: 1px solid var(--border-color);
            }
            :host .link-btn {
                width: 100%;
                padding: 16px;
                background-color: transparent;
                border: none;
            }
            :host .message {
                font-style: italic;
                line-height: 1.6;
            }
        </style>

        <template is="dom-if" if="[[ _newNotifications ]]">
            <paper-icon-button
                    id="newNotificationsAction"
                    class="action-icon new-notifications-icon"
                    icon="social:notifications-active"
                    title="Notifications"
                    on-tap="_onNewNotificationsAction">
            </paper-icon-button>
        </template>

        <template is="dom-if" if="[[ !_newNotifications ]]">
            <paper-icon-button
                    id="notificationsAction"
                    class="action-icon"
                    icon="social:notifications"
                    title="Notifications"
                    on-tap="_onNotificationsAction">
            </paper-icon-button>
        </template>

        <appsco-dropdown
                open="{{ _pressed }}"
                trigger="[[ _triggerDropdown ]]"
                close-outside>

                <paper-card heading="Notifications">

                    <appsco-loader active="[[ _loader ]]" loader-alt="Loading notifications" multi-color></appsco-loader>

                    <div class="card-content card-content-notifications layout vertical">

                        <iron-ajax
                            id="ironAjaxNotifications"
                            url="http://appsco.loc/app_dev.php/api/v2/me/notifications"
                            handle-as="json"
                            on-error="_handleError"
                            on-response="_handleResponse">
                        </iron-ajax>

                        <template is="dom-repeat" items="{{ _notifications }}">

                            <div class="divider"></div>

                            <appsco-account-notification
                                    notification="[[ item ]]">
                            </appsco-account-notification>

                        </template>

                    </div>

                    <template is="dom-if" if="[[ _message ]]">
                        <div class="card-content layout horizontal center">
                            <p class="message">
                                [[ _message ]]
                            </p>
                        </div>
                    </template>

                    <div class="card-actions layout vertical center" hidden$="[[ !_notificationsExists }}">
                        <paper-button id="seeAllNotifications" class="default-btn link-btn">See all notifications</paper-button>
                    </div>

                </paper-card>

        </appsco-dropdown>

    </template>

    <script>
        Polymer({

            is: 'appsco-account-notifications',

            properties: {

                /**
                 * Notifications for account.
                 * Get from Appsco API within iron-ajax.
                 *
                 * @type Notification[]
                 */
                _notifications: {
                    type: Array,
                    notify: true
                },

                /**
                 * Indicates if notifications are loaded or not.
                 */
                _notificationsExists: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Indicates if there are new notifications.
                 */
                _newNotifications: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Message to display instead of notifications.
                 */
                _message: {
                    type: String
                },

                /**
                 * Indicates if user clicked on element or not.
                 */
                _pressed: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },

                /**
                 * DOM element which triggers the dropdown.
                 */
                _triggerDropdown: {
                    type: Object,
                    notify: true
                },

                /**
                 * Indicates if appsco-loader is shown or hidden.
                 */
                _loader: {
                    type: Boolean,
                    value: true
                }
            },

            listeners: {
                'seeAllNotifications.tap': '_seeAllNotificationsAction'
            },

            ready: function() {
                var basic = btoa('nikola@free.com' + ':' + 'Nikola.Appscov2');
                this.$.ironAjaxNotifications.headers.authorization = "Basic " + basic;

                // This is set just to see how it works.
                // Should be removed after implementation of 'new notifications' scenario.
                // We should see how to check if there are new notifications.
                setTimeout(function() {

                    this._newNotifications = true;

                }.bind(this), 3000);
            },

            attached: function() {
                this._triggerDropdown = this.$$('#notificationsAction');
            },

            /**
             * Toggles chat dropdown.
             *
             * @private
             */
            _toggleDropdownAction: function() {
                this._pressed = !this._pressed;

                if (this._pressed) {
                    this._loadNotifications();
                }
            },

            /**
             * Fires event on see all notifications action.
             *
             * @private
             */
            _seeAllNotificationsAction: function() {

                /**
                 * Fired when user taps on see all notifications action.
                 *
                 * @event all-notifications
                 */
                this.fire('all-notifications');
            },

            /**
             * Triggers ajax request in order to get notifications.
             *
             * @private
             */
            _loadNotifications: function() {
                this._loader = true;
                this._notifications = [];
                this._notificationsExists = false;
                this.$.ironAjaxNotifications.generateRequest();
            },

            /**
             * Handles error on get notifications API request.
             * @param {Object} event Event from error response.
             *
             * @private
             */
            _handleError: function(event) {

//                this._message = 'We couldn\'t load notifications at the moment. Please try again in a minute. If error continues contact us.';


                var notifications = [
                    {
                        image: 'https://apps.appsco.com/icon/199.png',
                        message: 'Appsco Apptest assigned you Telenor Avansert Sentralbord on Telecom Test Dash',
                        date: '22/9/2016'
                    },
                    {
                        image: 'https://apps.appsco.com/icon/199.png',
                        message: 'You have been added to Telecom Test Dash',
                        date: '22/9/2016'
                    },
                    {
                        image: 'https://apps.appsco.com/icon/199.png',
                        message: 'Appsco Apptest assigned you Telenor Mine Sider on Telecom Test Dash',
                        date: '22/9/2016'
                    },
                    {
                        image: 'https://apps.appsco.com/icon/199.png',
                        message: 'You have been added to Telecom Test Dash',
                        date: '22/9/2016'
                    },
                    {
                        image: 'https://apps.appsco.com/icon/199.png',
                        message: 'Appsco Apptest assigned you Telenor Mine Sider on Telecom Test Dash',
                        date: '22/9/2016'
                    }

                ];

                if (notifications && notifications.length > 0) {

                    notifications.forEach(function(notification, i) {

                        setTimeout( function() {

                            this.push('_notifications', notifications[i]);

                            if (i === (notifications.length - 1)) {
                                this._notificationsExists = true;
                            }

                        }.bind(this), (i + 1) * 50 );

                    }.bind(this));

                }
                else if (notifications && notifications.length === 0) {
                    this._message = 'You don\'t have notifications.';
                }
                else {
                    this._message = 'We couldn\'t load notifications at the moment.';
                }


                this._loader = false;
            },

            /**
             * Handles response on get notifications API request.
             * @param {Object} event Event from response.
             *
             * @private
             */
            _handleResponse: function(event) {
                var notifications = event.detail.response.notifications;

                if (notifications && notifications.length > 0) {

                    notifications.forEach(function(notification, i) {

                        setTimeout( function() {

                            this.push('_notifications', notifications[i]);

                            if (i === (notifications.length - 1)) {
                                this._notificationsExists = true;
                            }

                        }.bind(this), (i + 1) * 50 );

                    }.bind(this));

                }
                else if (notifications.length === 0) {
                    this._message = 'You don\'t have notifications.';
                }
                else {
                    this._message = 'We couldn\'t load notifications at the moment.';
                }

                this._loader = false;

            },

            /**
             * Handles notifications action.
             *
             * @private
             */
            _onNotificationsAction: function() {
                this._triggerDropdown = this.$$('#notificationsAction');
                this._toggleDropdownAction();
            },

            /**
             * Handles notifications action when there are new notifications.
             *
             * @private
             */
            _onNewNotificationsAction: function() {
                this._triggerDropdown = this.$$('#newNotificationsAction');
                this._newNotifications = false;
                this._toggleDropdownAction();
            }

        });
    </script>
</dom-module>
