<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">

<!--
`appsco-application-analytics-info`
Contains various analytic information about application.

    <appsco-application-analytics-info
        application="{}"></appsco-application-analytics-info>

### Styling

`<appsco-application-analytics-info>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--appsco-application-analytics-info` | Mixin applied to the root element | `{}`
`--analytics-info` | Mixin applied to info box. | `{}`

@demo demo/appsco-application-analytics-info.html
-->

<dom-module id="appsco-application-analytics-info">
    <template>
        <style>
            :host {
                display: block;
                @apply(--appsco-application-analytics-info);
            }
            .info {
                @apply(--paper-font-body1);
                line-height: 24px;
                @apply(--analytics-info);
            }
        </style>

        <iron-ajax auto
                   url="[[ _computedAction ]]"
                   on-response="_onResponse"
                   on-error="_onError"
                   headers="{{ _computedHeaders }}"></iron-ajax>

        <template is="dom-if" if="[[ _analyticsExists ]]">
            <div class="info">
                Configured [[ _analytics.instances.configured ]] out of [[ _analytics.number_of_assignees ]] instances.
            </div>

            <div class="info">
                Edited on [[ _lastEditedDate ]] by [[ _analytics.last_edited.displayName ]].
            </div>

            <div class="info">
                Last used by [[ _analytics.last_used.displayName ]].
            </div>

            <div class="info">
                Daily usage: [[ _analytics.daily_usage ]]%.
            </div>

            <template is="dom-if" if="[[ _analytics.share_settings.configured_by_user ]]">
                <div class="info">
                    Application is set to be configured by users.
                </div>
            </template>

            <template is="dom-if" if="[[ !_analytics.share_settings.configured_by_user ]]">
                <div class="info">
                    Application is set to be configured by admin for all users.
                </div>
            </template>
        </template>


        <template is="dom-if" if="[[ !_analyticsExists ]]">
            <template is="dom-if" if="{{ _message }}">
                <p class="message">
                    [[ _message ]]
                </p>
            </template>
        </template>

    </template>

    <script>
        Polymer({

            is: 'appsco-application-analytics-info',

            properties: {

                /**
                 * Application for which to retrieve analytics.
                 */
                application: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * Analytics object that contains info.
                 */
                _analytics: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                _analyticsExists: {
                    type: Boolean,
                    value: false
                },

                _lastEditedDate: {
                    type: String,
                    computed: '_computeLastEditedDate(_analytics)'
                },

                /**
                 * Authorization token.
                 */
                authorizationToken: {
                    type: String
                },

                /**
                 * Computed action to call in order to get analytics for application.
                 */
                _computedAction: {
                    type: String,
                    computed: "_computeAction(application)"
                },

                /**
                 * Computed headers.
                 * It contains authorization token.
                 */
                _computedHeaders: {
                    type: Object,
                    computed: "_computeHeaders(authorizationToken)"
                },

                /**
                 * Message to display instead of analytics info.
                 */
                _message: {
                    type: String
                },

                /**
                 * Animation config.
                 */
                animationConfig: {
                    value: function() {
                        return {
                            'entry': {
                                name: 'fade-in-animation',
                                node: this,
                                timing: {
                                    duration: 500
                                }
                            },
                            'exit': {
                                name: 'fade-out-animation',
                                node: this,
                                timing: {
                                    duration: 100
                                }
                            }
                        }
                    }
                }
            },

            behaviors: [
                Polymer.NeonAnimationRunnerBehavior
            ],

            /**
             * Computes action for analytics.
             *
             * @param {String} analyticsApi
             * @returns {string}
             * @private
             */
            _computeAction: function (application) {
                return application.meta ? 'meta.analytics/' : '/analytics';
//                return application.meta ? application.meta.analytics : '/analytics';
            },

            /**
             * Computes authorization headers.
             *
             * @param {Object} authorizationToken
             * @returns {{Authorization: string}}
             * @private
             */
            _computeHeaders: function (authorizationToken) {
                return {
                    'Authorization': 'token ' + authorizationToken
                }
            },

            _computeLastEditedDate: function(analytics) {
                return analytics.last_edited ? this._dateFormat(analytics.last_edited.date) : '';
            },

            _showAnalytics: function() {
                this._analyticsExists = true;
                this.style.display = 'block';
                this.playAnimation('entry');
            },

            /**
             * Formats date and returns formatted date as string.
             *
             * @param {String} value
             * @returns {string}
             * @private
             */
            _dateFormat: function(value) {

                if (value) {

                    var options = {
                        year: "numeric", month: "short", day: "numeric"
                    };

                    return (new Date(value)).toLocaleDateString('en', options);
                }

            },

            _onError: function() {
//                this._analyticsExists = false;
//                this._message = 'We couldn\'t load analytics at the moment. Please try again in a minute.';

                /**
                 * Present for testing purposes.
                 * When API call implements remove it.
                 *
                 * START
                 */
                this._analytics = {
                    number_of_assignees: 17,
                    instances: {
                        configured: 14,
                        unconfigured: 3
                    },
                    last_edited: {
                        date: '2016-12-08 00:00:00.000000',
                        displayName: 'Boris Vujicic'
                    },
                    last_used: {
                        displayName: 'Nikola Vucinic'
                    },
                    daily_usage: 84,
                    share_settings: {
                        configured_by_user: true
                    }
                };

                this._showAnalytics();
                /**
                 * Present for testing purposes.
                 * When API call implements remove it.
                 *
                 * END
                 */
            },

            _onResponse: function(event) {
                var response = event.detail.response.analytics;

                if (response) {
                    this._analytics = response;

                    this._showAnalytics();
                }
            }
        });
    </script>
</dom-module>
