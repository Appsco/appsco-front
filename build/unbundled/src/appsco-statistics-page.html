<html><head><link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">

<link rel="import" href="../bower_components/appsco-page/appsco-content.html">
<link rel="import" href="../bower_components/appsco-components/appsco-loader.html">


<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="shared-styles.html">

</head><body><dom-module id="appsco-statistics-page">
    <template>
        <style include="webkit-scrollbar-style">
            :host {
                --body-background-color: white;
                display: block;
                color: var(--primary-text-color);
                font-size: 14px;

                --appsco-content-sections: {
                    padding: 0;
                };
            }
            :host div[content] {
                padding: 10px;
                color: var(--primary-text-color);
            }
            :host div[info] {
                padding: 10px;
                color: var(--primary-text-color);
            }
            .two-charts {
                @apply(--layout-horizontal);
                @apply(--layout-center);
            }
            .chart-container {
                @apply(--layout-flex);
                position: relative;
            }
            google-chart {
                height: 300px;
                width: 100%;
                padding: 0 10px;
                margin-bottom: 20px;
                box-sizing: border-box;
                /*background-color: var(--body-background-color);*/
            }
            .chart-h-380 {
                height: 380px;
            }
            .two-fa-chart {
                max-width: 1000px;
            }
            .title-h2 {
                padding-left: 10px;
                margin: 10px 0 20px 0;
                font-weight: 500;
                text-align: center;
            }
            :host([medium-screen]) .two-charts {
                @apply(--layout-vertical);
            }
            :host([medium-screen]) .chart-container {
                @apply(--layout-flex-none);
                width: 100%;
            }
        </style>

        <iron-ajax id="applicationUsageAjax" auto="" url="[[ companyApi ]]/statistics/application-usage" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleApplicationUsageResponse"></iron-ajax>

        <iron-ajax id="applicationSecurityAjax" auto="" url="[[ companyApi ]]/statistics/application-security" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleApplicationSecurityResponse"></iron-ajax>

        <iron-ajax id="userSecurityAjax" auto="" url="[[ companyApi ]]/statistics/user-password-scores" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleUserPasswordsScoresResponse"></iron-ajax>

        <iron-ajax id="loginAttemptsAjax" auto="" method="POST" url="[[ companyApi ]]/statistics/login-attempts" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleLoginAttemptsResponse"></iron-ajax>

        <iron-ajax id="twoFaAjax" auto="" url="[[ companyApi ]]/statistics/twofa" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleTwoFaResponse"></iron-ajax>

        <iron-ajax id="licenceAjax" auto="" url="[[ companyApi ]]/statistics/licences" handle-as="json" headers="[[ _computedHeaders ]]" on-response="_handleLicencesResponse"></iron-ajax>

        <iron-media-query query="(max-width: 1200px)" query-matches="{{ mediumScreen }}"></iron-media-query>

        <appsco-content id="appscoContent">

            <div content="">

                <div class="two-charts">
                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _applicationsUsageChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">Applications usage</h2>
                        <google-chart id="applicationsUsageChart" class="chart-h-380" type="column" on-google-chart-ready="_onApplicationsUsageChartReady"></google-chart>
                    </div>

                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _applicationSecurityChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">Application security</h2>
                        <google-chart id="applicationSecurityChart" class="chart-h-380" type="column" on-google-chart-ready="_onApplicationSecurityChartReady"></google-chart>
                    </div>
                </div>

                <div class="two-charts">
                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _userSecurityChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">User security</h2>
                        <google-chart id="userSecurityChart" class="chart-h-380" type="column" on-google-chart-ready="_onUserSecurityChartReady"></google-chart>
                    </div>

                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _loginAttemptsChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">Login attempts</h2>
                        <google-chart id="loginAttemptsChart" class="chart-h-380" type="column" on-google-chart-ready="_onLoginAttemptsChartReady">

                        </google-chart>
                    </div>
                </div>

                <div class="two-charts">
                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _twoFaChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">Two-factor authentication</h2>
                        <google-chart id="twoFaChart" class="chart-h-380 two-fa-chart" type="pie" on-google-chart-ready="_onTwoFaChartReady">

                        </google-chart>
                    </div>

                    <div class="chart-container">
                        <appsco-loader multi-color="" active="[[ _licenceChartLoader ]]"></appsco-loader>

                        <h2 class="title-h2">AppsCo licences</h2>
                        <google-chart id="licenceChart" class="chart-h-380 two-fa-chart" type="pie" on-google-chart-ready="_onLicenceChartReady">

                        </google-chart>
                    </div>
                </div>

            </div>
        </appsco-content>
    </template>

    <script>Polymer({is:"appsco-statistics-page",properties:{companyApi:{type:String},authorizationToken:{type:String},_computedHeaders:{type:Object,computed:"_computeHeaders(authorizationToken)"},_applicationsUsageChartLoader:{type:Boolean,value:!0},_applicationSecurityChartLoader:{type:Boolean,value:!0},_userSecurityChartLoader:{type:Boolean,value:!0},_loginAttemptsChartLoader:{type:Boolean,value:!0},_twoFaChartLoader:{type:Boolean,value:!0},_licenceChartLoader:{type:Boolean,value:!0},mediumScreen:{type:Boolean,value:!1,reflectToAttribute:!0},pageLoaded:{type:Boolean,value:!1}},observers:["_updateScreen(mediumScreen)"],attached:function(){this.pageLoaded=!1,this.mediumScreen&&this.updateStyles(),this._pageLoaded()},_updateScreen:function(t){this.updateStyles()},_computeHeaders:function(t){return{Authorization:"token "+t}},_computeSubscriptionApi:function(t){return t+"/billing/subscription"},_pageLoaded:function(){this.pageLoaded=!0,this.fire("page-loaded")},_showLoader:function(t){this.set(t,!0)},_hideLoader:function(t){this.set(t,!1)},reloadStatistics:function(){this._showLoader("_applicationsUsageChartLoader"),this.$.applicationUsageAjax.generateRequest(),this._showLoader("_applicationSecurityChartLoader"),this.$.applicationSecurityAjax.generateRequest(),this._showLoader("_userSecurityChartLoader"),this.$.userSecurityAjax.generateRequest(),this._showLoader("_loginAttemptsChartLoader"),this.$.loginAttemptsAjax.generateRequest(),this._showLoader("_twoFaChartLoader"),this.$.twoFaAjax.generateRequest(),this._showLoader("_licenceChartLoader"),this.$.licenceAjax.generateRequest()},_handleApplicationUsageResponse:function(t){var e=t.detail.response,a=this.$.applicationsUsageChart;a.options={titlePosition:"none",backgroundColor:this.getComputedStyleValue("--body-background-color"),animation:{startup:"true",duration:600,easing:"in"},legend:"none"},e&&(a.data=[["Data type","Count",{role:"style"}],["Total applications",e.applications,"#279FBC"],["Applications with instances",e.applications_with_instances,"#279FBC"],["Applications without instances",e.applications_without_instances,"#279FBC"],["Total application instances",e.application_instances,"#279FBC"],["Configured application instances",e.application_instances_configured,"#279FBC"]])},_onApplicationsUsageChartReady:function(){this._hideLoader("_applicationsUsageChartLoader")},_handleApplicationSecurityResponse:function(t){var e=t.detail.response,a=this.$.applicationSecurityChart,o=["Application","Application score","Configured","Not configured"];if(a.data=[o],a.options={titlePosition:"none",backgroundColor:this.getComputedStyleValue("--body-background-color"),hAxis:{title:"Applications"},vAxis:{title:"Security score (%)",viewWindowMode:"explicit",viewWindow:{min:0,max:100},gridlines:{count:10}},animation:{startup:"true",duration:600,easing:"in"}},e)for(var i=e.length>10?10:e.length,n=0;n<i;n++){var r=e[n],s=[];s.push(r.application.title),s.push(r.report.score),s.push(r.report.info.configured),s.push(r.report.info.not_configured),a.data.push(s)}},_onApplicationSecurityChartReady:function(){this._hideLoader("_applicationSecurityChartLoader")},_handleUserPasswordsScoresResponse:function(t){var e=t.detail.response,a=this.$.userSecurityChart,o=["User","Overall score","Number of applications"];if(a.data=[o],a.options={titlePosition:"none",backgroundColor:this.getComputedStyleValue("--body-background-color"),hAxis:{title:"User"},vAxis:{title:"Security score (%)",viewWindowMode:"explicit",viewWindow:{min:0,max:100},gridlines:{count:10}},animation:{startup:"true",duration:600,easing:"in"}},e)for(var i=e.length>10?10:e.length,n=0;n<i;n++){for(var r=e[n],s=r.application_scores,c=r.application_scores.length,l=0,p=[],u=0;u<c;u++)l+=s[u].score;p.push(r.user.name,c>0?l/c:0,c),a.data.push(p)}},_onUserSecurityChartReady:function(){this._hideLoader("_userSecurityChartLoader")},_handleLoginAttemptsResponse:function(t){var e=t.detail.response,a=this.$.loginAttemptsChart,o=e.length,i=["Day in month"],n=[];a.options={titlePosition:"none",hAxis:{title:"Last 15 days",viewWindowMode:"explicit",viewWindow:{min:0,max:15},gridlines:{count:15}},vAxis:{title:"Login attempts",format:"0"},backgroundColor:this.getComputedStyleValue("--body-background-color"),animation:{startup:"true",duration:600,easing:"in"}};for(var r=0;r<o;r++){var s=e[r],c=new Date(s.created_at.date),c=c.toLocaleDateString("en",{month:"short",day:"numeric"});i.indexOf(s.application.title)==-1&&i.push(s.application.title),n[c]||(n[c]=[]),n[c][s.application.title]=n[c][s.application.title]?n[c][s.application.title]+1:1}a.data=[i];for(var r=14;r>=0;r--){var c=new Date,l=[];c.setDate(c.getDate()-r),c=c.toLocaleDateString("en",{month:"short",day:"numeric"}),l.push(c),n[c]||(n[c]=[]);for(var p=1;p<i.length;p++)n[c][i[p]]=n[c][i[p]]?n[c][i[p]]:0,l.push(n[c][i[p]]);a.data.push(l)}},_onLoginAttemptsChartReady:function(){this._hideLoader("_loginAttemptsChartLoader")},_handleTwoFaResponse:function(t){var e=t.detail.response,a=this.$.twoFaChart;a.options={title:"Total users: "+(e.active+e.inactive),titleTextStyle:{color:this.getComputedStyleValue("--primary-text-color"),bold:!1},backgroundColor:this.getComputedStyleValue("--body-background-color"),animation:{startup:"true",duration:600,easing:"in"},slices:{0:{color:this.getComputedStyleValue("--success-color")},1:{color:this.getComputedStyleValue("--app-danger-color")}}},e&&(a.data=[["Data type","Count"],["Two-factor authentication active",e.active],["Two-factor authentication inactive",e.inactive]])},_onTwoFaChartReady:function(){this._hideLoader("_twoFaChartLoader")},_handleLicencesResponse:function(t){var e=t.detail.response,a=this.$.licenceChart;a.options={title:"Total licences: "+e.appscoLicences,titleTextStyle:{color:this.getComputedStyleValue("--primary-text-color"),bold:!1},backgroundColor:this.getComputedStyleValue("--body-background-color"),animation:{startup:"true",duration:600,easing:"in"},slices:{0:{color:this.getComputedStyleValue("--success-color")},1:{color:this.getComputedStyleValue("--app-danger-color")},2:{color:"#279FBC"}}},e&&(a.data=[["Data type","Count"],["Used licences",e.currentLicences],["Unused licences",e.appscoLicences-e.currentLicences],["Active users",e.active_users]])},_onLicenceChartReady:function(){this._hideLoader("_licenceChartLoader")}});</script>
</dom-module>
</body></html>